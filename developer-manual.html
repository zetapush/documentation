<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.6.1">
<title>Developer manual</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script type="text/javascript" src=".//javascripts/menu.js"></script>
<script type="text/javascript" src=".//javascripts/sidebar.js"></script>
<script type="text/javascript" src=".//javascripts/steps.js"></script>
<script type="text/javascript" src=".//javascripts/sourcecode/source-utils.js"></script>
<script type="text/javascript" src=".//javascripts/sourcecode/highlight-lines.js"></script>
<script type="text/javascript" src=".//javascripts/sourcecode/collapse-lines.js"></script>
<script type="text/javascript" src=".//javascripts/tabcontainer.js"></script>
<script type="text/javascript" src="//unpkg.com/clipboard@2.0.0/dist/clipboard.min.js"></script>
<script type="text/javascript" src=".//javascripts/clipboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3/dist/instantsearch.min.js"></script>
<script type="text/javascript" src=".//javascripts/search.js"></script>
<!-- <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/bootswatch/2.3.2/united/bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css"
  /> -->
<link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,800" rel="stylesheet">
<link rel="stylesheet" type="text/css" href=".//styles/zetapush-styles.css" />
<link rel="stylesheet" type="text/css" href=".//styles/custom-styles.css" />
<link rel="stylesheet" type="text/css" href=".//styles/tabcontainer.css" />
<link rel="stylesheet" type="text/css" href=".//styles/steps.css" />
<link rel="stylesheet" type="text/css" href=".//styles/sourcecode/collapse-lines.css" />
<link rel="stylesheet" type="text/css" href=".//styles/sourcecode/highlight-lines.css" />
<link rel="stylesheet" type="text/css" href=".//styles/clipboard.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.3/dist/instantsearch.min.css">
<script type="text/html" id="hit-template">
  <div class="hit">
    <div class="hit-content">
      <div class="context">
        <a href="{{sourceFile.url}}">{{sourceFile.title}}</a>
        {{#parents}}
          <a href="{{url}}">{{title}}</a>
        {{/parents}}
        <a href="{{url}}">{{{_highlightResult.title.value}}}</a>
      </div>
      <pre class="hit-description">{{{_highlightResult.content.value}}}</pre>
    </div>
  </div>
</script>
<header>
  <nav>
    <div class="main-title"><span></span><i class="fa fa-caret-down"></i></div>
    <ul>
      <li><a href="/documentation"><span>ZetaPush documentation</span><i class="fa fa-angle-right"></i></a></li>
      <li><a href="/documentation/getting-started.html"><span>Getting Started</span><i class="fa fa-angle-right"></i></a></li>
      <li><a href="/documentation/developer-manual.html"><span>Developer manual</span><i class="fa fa-angle-right"></i></a></li>
      <li><a href="/documentation/how-to.html"><span>How to guides</span><i class="fa fa-angle-right"></i></a></li>
      <li><a href="/documentation/tutorials.html"><span>Tutorials</span><i class="fa fa-angle-right"></i></a></li>
      <li><a href="/documentation/reference.html"><span>Reference</span><i class="fa fa-angle-right"></i></a></li>
      <li><a href="http://docv2.zetapush.com"><span>Documentation v2</span><i class="fa fa-angle-right"></i></a></li>
    </ul>
    <div>
      <div class="contact-us">
        <a href="https://www.zetapush.com/contact" target="_blank">Contact us</a>
      </div>
      <div class="github">
        <a href="https://github.com/zetapush" target="_blank">
          <span>Join us on</span><i class="fa fa-github-alt" title="Github"></i></a>
      </div>
      <div class="search">
        <input id="search-input" placeholder="Search for products">
        <div class="search-results">
          <div id="search-hits"></div>
        </div>
      </div>
      <div class="logo">
        <a href="https://www.zetapush.com"><span class="icon"></span></a>
      </div>
    </div>
  </nav>
</header>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Developer manual</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_requirements">Requirements</a>
<ul class="sectlevel2">
<li><a href="#_system_requirements">System requirements</a></li>
<li><a href="#_using_cli">Using CLI</a></li>
</ul>
</li>
<li><a href="#_zetapush_concepts">ZetaPush concepts</a>
<ul class="sectlevel2">
<li><a href="#_create_your_account">Create your account</a></li>
</ul>
</li>
<li><a href="#_develop_your_front_with_zetapush">Develop your front with ZetaPush</a></li>
<li><a href="#_develop_your_business_logic">Develop your business logic</a>
<ul class="sectlevel2">
<li><a href="#_what_is_a_em_custom_cloud_service_em">What is a <em>custom cloud service</em></a></li>
<li><a href="#_develop_a_em_custom_cloud_services_em">Develop a <em>custom cloud services</em></a></li>
<li><a href="#_develop_fast">Develop fast</a></li>
</ul>
</li>
<li><a href="#_deploy_publish_your_application">Deploy/publish your application</a>
<ul class="sectlevel2">
<li><a href="#_what_will_be_deployed">What will be deployed ?</a></li>
<li><a href="#_environments">Environments</a></li>
<li><a href="#_deploy_application_on_the_zetapush_cloud">Deploy application on the ZetaPush Cloud</a></li>
</ul>
</li>
<li><a href="#_user_management_in_your_application">User management in your application</a>
<ul class="sectlevel2">
<li><a href="#_presentation">Presentation</a></li>
<li><a href="#_quick_start">Quick start</a></li>
</ul>
</li>
<li><a href="#_store_data_in_your_application">Store data in your application</a></li>
<li><a href="#_secure_your_application">Secure your application</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_requirements"><a class="anchor" href="#_requirements"></a>Requirements</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you already prepared your environment, you can skip this section.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_system_requirements"><a class="anchor" href="#_system_requirements"></a>System requirements</h3>
<div class="paragraph">
<p>To create a ZetaPush application you only need the Node.js ecosystem:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Node.js version 10.3.0 (LTS) or higher</p>
</li>
<li>
<p>npm version &gt;= 6.4</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Install Node.js and npm</strong></p>
</div>
<div class="paragraph">
<p>Go to <a href="https://nodejs.org/en/download/" target="_blank" rel="noopener">Node.js Downloads</a> and follow the installation instructions.</p>
</div>
<div class="paragraph">
<p>You also need to install additional tools for Node.js:</p>
</div>
<div class="paragraph tab-container">
<p>Additional tools</p>
</div>
<div class="paragraph tab">
<p>Windows</p>
</div>
<div class="paragraph">
<p>You must install development tools on Windows (Visual Studio Build Tools and Python).
Fortunately, there is a npm tool that helps you to install all required dependencies.
You must run this command line using <strong>PowerShell</strong> as <strong>Administrator</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">npm install --global --production windows-build-tools</code></pre>
</div>
</div>
<div class="paragraph">
<p>Be patient! It may take a while.</p>
</div>
<div class="paragraph tab">
<p>Debian/Ubuntu</p>
</div>
<div class="paragraph">
<p>Install build tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">sudo apt-get install -y build-essential</code></pre>
</div>
</div>
<div class="paragraph tab">
<p>Enterprise Linux and Fedora</p>
</div>
<div class="paragraph">
<p>Install build tools:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">sudo yum install gcc-c++ make
# or: sudo yum groupinstall 'Development Tools'</code></pre>
</div>
</div>
<div class="paragraph tab-container-end">
<p>-</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_cli"><a class="anchor" href="#_using_cli"></a>Using CLI</h3>
<div class="paragraph">
<p>Once your have your application ready (see <a href="./quick-start.html">Quick start</a> if you don&#8217;t have created an application) you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Run the backend code (Worker) locally</p>
</li>
<li>
<p>Deploy your application</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To do this we provide a <em>CLI</em> (Command Line Interface) to help you focus on your code and not spend time on writing commands or scripts.</p>
</div>
<div class="paragraph">
<p>The <em>CLI</em> module is declared in the <code>package.json</code> of the project so it is installed by npm when you create your project
(see <a href="./quick-start.html#_create_your_first_application">how to create an application using npm</a> if you haven&#8217;t created a project).</p>
</div>
<div class="paragraph">
<p>When the project is created, we configure the <code>package.json</code> with a <code>scripts</code> section to make aliases that work
directly with npm.</p>
</div>
<div class="sect3">
<h4 id="_use_npm_script_aliases_to_run_the_em_cli_em"><a class="anchor" href="#_use_npm_script_aliases_to_run_the_em_cli_em"></a>Use npm script aliases to run the <em>CLI</em></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run &lt;alias&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want to run your worker locally using script alias, you can execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run start</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>start</code> alias calls <code>zeta run</code> under the hood.</p>
</div>
<div class="paragraph">
<p>The <code>start</code> alias is used because it is the standard alias to use in development.
We follow npm conventions so a user that is used to npm know which command to
execute to start is project locally.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to deploy your application using script alias, you can execute:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run deploy</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The <code>start</code> alias calls <code>zeta push</code> under the hood.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_use_em_cli_em_directly"><a class="anchor" href="#_use_em_cli_em_directly"></a>Use <em>CLI</em> directly</h4>
<div class="paragraph">
<p>With the CLI, you can run your worker with:</p>
</div>
<div class="listingblock">
<div class="title">Run worker</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>$ zeta run</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or deploy your application with:</p>
</div>
<div class="listingblock">
<div class="title">Deploy the application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>$ zeta push</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>There are 3 ways to use directly <code>zeta</code> commands provided by the <em>CLI</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Set an environment variable that points to your local <code>node_modules/.bin</code> (recommended)</p>
</li>
<li>
<p>Use <code>npx</code> tool</p>
</li>
<li>
<p>Install <em>CLI</em> as global (not recommended)</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_update_your_path_environment_variable_recommended"><a class="anchor" href="#_update_your_path_environment_variable_recommended"></a>Update your PATH environment variable (recommended)</h5>
<div class="paragraph">
<p>In order to be able to run <code>zeta</code> commands directly, you need to update your PATH.</p>
</div>
<div class="paragraph tab-container">
<p>Update environement variables</p>
</div>
<div class="paragraph tab">
<p>Debian/Ubuntu/MacOSX</p>
</div>
<div class="paragraph">
<p>You need to add it to your shell config file <code>~/.zshrc</code>, <code>~/.profile</code> or <code>~/.bashrc</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ export PATH=./node_modules/.bin:$PATH</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that this will not automatically update your path for the remainder of the session. To do this, you should run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ source ~/.zshrc
$ source ~/.profile
$ source ~/.bashrc</code></pre>
</div>
</div>
<div class="paragraph tab">
<p>Windows 10 and Windows 8</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In Search, search for and then select: System (Control Panel)</p>
</li>
<li>
<p>Click the Advanced system settings link.</p>
</li>
<li>
<p>Click Environment Variables. In the section System Variables, find the PATH environment variable and select it. Click Edit. If the PATH environment variable does not exist, click New.</p>
</li>
<li>
<p>In the Edit System Variable (or New System Variable) window, specify the value of the PATH environment variable. Click OK. Close all remaining windows by clicking OK.</p>
</li>
<li>
<p>Reopen Command prompt window, and run zeta command.</p>
</li>
</ul>
</div>
<div class="paragraph tab">
<p>Windows 7</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From the desktop, right click the Computer icon.</p>
</li>
<li>
<p>Choose Properties from the context menu.</p>
</li>
<li>
<p>Click the Advanced system settings link.</p>
</li>
<li>
<p>Click Environment Variables. In the section System Variables, find the PATH environment variable and select it. Click Edit. If the PATH environment variable does not exist, click New.</p>
</li>
<li>
<p>In the Edit System Variable (or New System Variable) window, specify the value of the PATH environment variable. Click OK. Close all remaining windows by clicking OK.</p>
</li>
<li>
<p>Reopen Command prompt window, and run zeta command.</p>
</li>
</ul>
</div>
<div class="paragraph tab">
<p>Windows Vista</p>
</div>
<div class="ulist">
<ul>
<li>
<p>From the desktop, right click the My Computer icon.</p>
</li>
<li>
<p>Choose Properties from the context menu.</p>
</li>
<li>
<p>Click the Advanced tab (Advanced system settings link in Vista).</p>
</li>
<li>
<p>Click Environment Variables. In the section System Variables, find the PATH environment variable and select it. Click Edit. If the PATH environment variable does not exist, click New.</p>
</li>
<li>
<p>In the Edit System Variable (or New System Variable) window, specify the value of the PATH environment variable. Click OK. Close all remaining windows by clicking OK.</p>
</li>
<li>
<p>Reopen Command prompt window, and run zeta command.</p>
</li>
</ul>
</div>
<div class="paragraph tab">
<p>Windows XP</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select Start, select Control Panel. double click System, and select the Advanced tab.</p>
</li>
<li>
<p>Click Environment Variables. In the section System Variables, find the PATH environment variable and select it. Click Edit. If the PATH environment variable does not exist, click New.</p>
</li>
<li>
<p>In the Edit System Variable (or New System Variable) window, specify the value of the PATH environment variable. Click OK. Close all remaining windows by clicking OK.</p>
</li>
<li>
<p>Reopen Command prompt window, and run zeta command.</p>
</li>
</ul>
</div>
<div class="paragraph tab-container-end">
<p>-</p>
</div>
</div>
<div class="sect4">
<h5 id="_use_npx_tool"><a class="anchor" href="#_use_npx_tool"></a>Use npx tool</h5>
<div class="paragraph">
<p>npx is shipped with npm standard install</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npx zeta &lt;command&gt;</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_install_zetapush_cli_as_a_global_command_not_recommended"><a class="anchor" href="#_install_zetapush_cli_as_a_global_command_not_recommended"></a>Install @zetapush/cli as a global command (not recommended)</h5>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm i -g @zetapush/cli</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_zetapush_concepts"><a class="anchor" href="#_zetapush_concepts"></a>ZetaPush concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to be able to use ZetaPush, you need a <strong>ZetaPush account</strong>. Your account is used when
you develop to run your project locally or to deploy it on ZetaPush cloud.</p>
</div>
<div class="paragraph">
<p>The code you produce is bound to an <strong>application</strong>.</p>
</div>
<div class="paragraph">
<p>An account belongs to an <strong>organization</strong>. An organization is useful to work in team.
You can have several applications for your organization.
You can manage access rights on applications according to members of your team.</p>
</div>
<div class="paragraph">
<p>As usual in development, you may need to run your application in different contexts (dev, continuous integration,
prod&#8230;&#8203;).
Each application may have several <strong>environments</strong>.
You can also manage access rights on environments according to members of your team.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Learn how to <a href="./reference.html#add_application">add an application to your organization</a>.</p>
</div>
<div class="paragraph">
<p>Learn how to <a href="./reference.html#add_environment">add an environment to your application</a>.</p>
</div>
<div class="paragraph">
<p>Learn how to <a href="./reference.html#access_control_per_application">control access for an application</a>.</p>
</div>
<div class="paragraph">
<p>Learn how to <a href="./reference.html#access_control_per_environment">control access for a particular environment</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For now, environments are not fully supported but this feature will be available soon.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_create_your_account"><a class="anchor" href="#_create_your_account"></a>Create your account</h3>
<div class="paragraph">
<p>Currently, the only way to get a ZetaPush account is by contacting us. The aim is to understand your needs
and to advise you even if you just want to test it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.zetapush.com/sign-up-for-a-free-trial/">Signup for a free trial</a></p>
</li>
<li>
<p><a href="https://www.zetapush.com/contact">Contact us for more suitable account</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Your account will be created soon after the first contact and an application that fits your
needs will be available. Then you are ready to start working with ZetaPush.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Soon we will open access to everyone for free trial. Account creation will be available through
our CLI tool, from the main site and the web console.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_develop_your_front_with_zetapush"><a class="anchor" href="#_develop_your_front_with_zetapush"></a>Develop your front with ZetaPush</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You may want to quickly provide a web application by just focusing on the visible part and the user experience
instead of wasting time on technical concerns.</p>
</div>
<div class="paragraph">
<p>ZetaPush provides built-in <em>cloud services</em> to increase your productivity:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<caption class="title">Table 1. List of ZetaPush cloud services</caption>
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Cloud service</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./reference.html#_standard_user_workflow">Standard User Workflow</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>The <code>StandardUserWorkflow</code> corresponds to the most common inscription process on the Internet. It handles:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Inscription of your end-users into your application: the user fills some information and <code>StandardUserWorkflow</code> sends an email
(or SMS or anything else) to the user in order to confirm its account. Once the user has confirmed its account, he can authenticate
himself and he is ready to use your application.</p>
</li>
<li>
<p>Authentication of your end-users</p>
</li>
<li>
<p>Lost password of your end-users: the user ask for resetting its password. <code>StandardUserWorkflow</code> sends an email (or SMS or anything else) to the user.
The user clicks the link in the email to choose another password. Once confirmed, its account is updated with the new password.</p>
</li>
<li>
<p>Profile edition: your end-users can update their information</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./reference.html#_user_management">User management</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>This section describes several services that provide basic user management functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./reference.html#_simple">Simple</a>: cloud functions to create a user, change credentials of a user, update a user or delete a user.</p>
</li>
<li>
<p><a href="./reference.html#_weak">Weak</a>: cloud functions to control and release of weakly authenticated user sessions.</p>
</li>
<li>
<p><a href="./reference.html#_userdir">Userdir</a>: cloud functions to retrieve and search users created by Simple.</p>
</li>
<li>
<p><a href="./reference.html#_groups">Groups</a>: cloud functions to handle group of users.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This APIs are available if <code>StandardUserWorkflow</code> doesn&#8217;t fit your needs or you want to go further.
Under the hood, <code>StandardUserWorkflow</code> use these services.</p>
</div>
</td>
</tr>
</table>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./reference.html#_data_management">Data management</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>This section describes several services that provide basic data management functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./reference.html#_gda">Gda</a>: NoSQL database that can store values, objects and arrays as document in columns.</p>
</li>
<li>
<p><a href="./reference.html#_stack">Stack</a>: Store values, objects and arrays in a stack. Each item is pushed in the stack and can be accessed later.</p>
</li>
<li>
<p><a href="./reference.html#_search_2">Search</a>: Search engine to make full text searches.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./reference.html#_file_management">File management</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>This section describes several services that provide basic file management functions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./reference.html#_zpfs_hdfs">Zpfs_hdfs</a>: Store files on a file system.</p>
</li>
<li>
<p><a href="./reference.html#_template">Template</a>: Define a template and then evaluate it with an execution context.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./reference.html#_communication">Communication</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>It is possible to interact with your end-users using these services:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./reference.html#_messaging">Messaging</a>: Send messages to a particular user (or a group of users). This is the service you use for a chat.</p>
</li>
<li>
<p><a href="./reference.html#_notif">Notif</a>: Send notifications to your end-users mobile phone (Android, iOS or Windows Phone).</p>
</li>
<li>
<p><a href="./reference.html#_sendmail">Sendmail</a>: Send emails to your end-users.</p>
</li>
<li>
<p><a href="./reference.html#_sms_ovh">Sms_ovh</a>: Send SMS to your end-users.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="./reference.html#_utilities_management">Utilities</a></p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>This section provides some utility tools:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./reference.html#_cron">Cron</a>: Schedule a task to be executed periodically.</p>
</li>
<li>
<p><a href="./reference.html#_logs">Logs</a>: Log some information. Logs will be available on ZetaPush cloud.</p>
</li>
<li>
<p><a href="./reference.html#_trigger">Trigger</a>: Listen to some event that is triggered by ZetaPush cloud and react to that event.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>ZetaPush cloud services need to be "created" before being able to use them. This way, you
can choose which services are part of your application instead of having them all.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Currently, using a front to interact with ZetaPush cloud services directly is not really possible due to
this "creation" phase. For security reasons, service creation and configuration can&#8217;t be done via
a client.</p>
</div>
<div class="paragraph">
<p>When the web console will be fully ready, ZetaPush cloud services "creation" will be
available through the web console.</p>
</div>
<div class="paragraph">
<p>Hopefully, you can use a worker to declare the use of a ZetaPush cloud service and even configure it. The
"creation" process is automatically handled by the worker.</p>
</div>
<div class="paragraph">
<p>See the next section to know how to develop <em>custom cloud services</em> and use <em>ZetaPush cloud services</em>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_develop_your_business_logic"><a class="anchor" href="#_develop_your_business_logic"></a>Develop your business logic</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Even if ZetaPush provides ready to use cloud services, we know that any application needs some
specific behaviors. Instead of limiting your possibilities, we provide a way to help you develop
quickly your own business logic.</p>
</div>
<div class="sect2">
<h3 id="_what_is_a_em_custom_cloud_service_em"><a class="anchor" href="#_what_is_a_em_custom_cloud_service_em"></a>What is a <em>custom cloud service</em></h3>
<div class="paragraph">
<p>A <em>custom cloud service</em> combines many <em>cloud functions</em> like the <em>cloud services</em> exposed by ZetaPush. The only difference is that <strong>you</strong> create the <em>cloud functions</em>.
Generally, you will want to put the <strong>business logic</strong> of your application in the <em>custom cloud services</em>.</p>
</div>
<div class="sect3">
<h4 id="_architecture"><a class="anchor" href="#_architecture"></a>Architecture</h4>
<div class="paragraph">
<p>You develop <em>cloud services</em> that are contained in a concept named <strong>worker</strong>. In your code it is
materialized by a folder named <code>worker</code>. The worker is the ZetaPush handler that starts your code (your <em>custom cloud services</em>).</p>
</div>
<div class="paragraph">
<p>Your application is composed of a logic part (the worker) and a UI part (the front).</p>
</div>
<div class="paragraph">
<p>There are two ways of running an application (worker and front):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You develop on your machine and iterate to provide features. Your application runs locally and interacts with ZetaPush Cloud.</p>
</li>
<li>
<p>Once you are ready to make the developed features available to your end-users, you publish your application. Your application runs directly in ZetaPush Cloud.</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_run_on_your_machine"><a class="anchor" href="#_run_on_your_machine"></a>Run on your machine</h5>
<div class="imageblock center">
<div class="content">
<img src="custom-cloud-service-dev.png" alt="custom cloud service dev" width="709" height="430">
</div>
<div class="title">Figure 1. Custom Cloud Service in development phase</div>
</div>
<div class="paragraph">
<p>Both front and worker are running locally. The front interacts with <em>custom cloud services</em> contained in the worker through
ZetaPush Cloud.
As ZetaPush Cloud provides bidirectional connection, the <em>custom cloud services</em> can also interact with the front through
ZetaPush Cloud too.</p>
</div>
<div class="paragraph">
<p>A <em>custom cloud service</em> can interact with <em>built-in cloud services</em> provided by ZetaPush.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When you start using ZetaPush, you only develop locally so from your point of vue,
your front seems to directly interact with your <em>custom cloud services</em>.</p>
</div>
<div class="paragraph">
<p>In fact, all messages go through the Internet and ZetaPush Cloud.
It means that a published front can interact with a worker that is running locally and vice versa.</p>
</div>
<div class="paragraph">
<p>See <a href="./reference.html#mix_local_and_remote">how to mix local worker with worker running in cloud</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_run_in_cloud"><a class="anchor" href="#_run_in_cloud"></a>Run in cloud</h5>
<div class="imageblock center">
<div class="content">
<img src="custom-cloud-service-prod.png" alt="custom cloud service prod" width="681" height="387">
</div>
<div class="title">Figure 2. Custom Cloud Service in production phase</div>
</div>
<div class="paragraph">
<p>Once published, everything runs in the ZetaPush Cloud. However the behavior is the same.
Every interaction between the front and <em>custom cloud services</em> goes through the ZetaPush Cloud.</p>
</div>
<div class="paragraph">
<p>The only main difference is that ZetaPush Cloud manages the hosting, the scalability and the
high availability for you.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_develop_a_em_custom_cloud_services_em"><a class="anchor" href="#_develop_a_em_custom_cloud_services_em"></a>Develop a <em>custom cloud services</em></h3>
<div class="sect3">
<h4 id="_define_a_em_custom_cloud_service_em"><a class="anchor" href="#_define_a_em_custom_cloud_service_em"></a>Define a <em>custom cloud service</em></h4>
<div class="paragraph">
<p>As a reminder worker is the ZetaPush container that will handle your code that defines <em>custom cloud services</em>.
By convention, the code of your <em>custom cloud services</em> is placed in files under <code>worker</code> directory:</p>
</div>
<div class="listingblock">
<div class="title">Tree structure convention</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">hello-world
├── <em>.zetarc</em>
├── <em>.gitignore</em>
├── <em>front</em>
│   ├── ...
│   └── ...
├── <strong>worker</strong>
│   ├── file1.ts
│   ├── file2.ts
│   ├── ...
│   ├── fileN.ts
│   └── index.ts
├── <em>package.json</em>
├── <em>README.md</em>
└── <em>tsconfig.json</em></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Change directory structure</div>
<div class="paragraph">
<p>See more information about <a href="./reference.html#different_directory_structures">directory structure convention and how to adapt the structure</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Translated into code, a <em>custom cloud service</em> is just a <code>class</code> and its <code>methods</code> are the  <em>cloud functions</em>.
The code is written in any <code>ts</code> file defined in <code>worker</code> directory. For small application like a "hello world",
write your code directly in <code>index.ts</code> file.
So the most basic example of a <em>custom cloud service</em> is below:</p>
</div>
<div class="listingblock">
<div class="title">Basic custom cloud service</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
</pre></td>
  <td class="code"><pre><span class="reserved">class</span> HelloWorldAsCustomCloudService {     <i class="conum" data-value="1"></i><b>(1)</b>

    constructor() {}                       <i class="conum" data-value="2"></i><b>(2)</b>

    helloWorld() {                         <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A custom cloud service is encapsulated in a JavaScript/TypeScript class. <strong>HelloWorldAsCustomCloudService</strong> is your first <em>custom cloud service</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A class can define a constructor. We will see later why it is important</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>helloWorld</code> is your first <em>custom cloud function</em></td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A <em>cloud function</em> is always asynchronous (with the <em>async</em> keyword or not)
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Change entry point</div>
<div class="paragraph">
<p>By default, the code above is directly written in <code>index.ts</code> file. This is done in order
to follow NodeJS conventions. Indeed, <code>index.ts</code> is the usually the file that imports
all other files.</p>
</div>
<div class="paragraph">
<p>You can write code of your <em>custom cloud services</em> in any other file named as you want.
You will see later how to indicate to ZetaPush worker how to find your files if you don&#8217;t
want to follow convention.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_define_a_em_cloud_function_em"><a class="anchor" href="#_define_a_em_cloud_function_em"></a>Define a <em>cloud function</em></h5>
<div class="paragraph">
<p>Each <em>cloud function</em> in a <em>custom cloud service</em> is a standard JavaScript/TypeScript
method.
For example, if you want a <em>cloud function</em> that receives two parameters you write:</p>
</div>
<div class="listingblock highlight-lines:8-14">
<div class="title">A more realistic <em>cloud function</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="reserved">class</span> HelloWorldAsCustomCloudService {                            <i class="conum" data-value="1"></i><b>(1)</b>
    constructor() {}

    helloWorld() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }

    saySomething(message: string, <span class="key">times</span>: number) {                <i class="conum" data-value="2"></i><b>(2)</b>
        let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
        <span class="keyword">for</span>(let i=<span class="integer">0</span> ; i&lt;times ; i++) {                            <i class="conum" data-value="3"></i><b>(3)</b>
            fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>
        }
        <span class="keyword">return</span> fullMessage                                        <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>custom cloud service</em> definition as seen before</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declaration of a <em>cloud function</em> named <code>saySomething</code>. This <em>cloud function</em> accepts
two parameters. As <a href="./reference.html#javascript_vs_typescript">TypeScript is the recommended way</a>, each parameter is typed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Just for an example, the business logic consists in looping a number of times
and concatenating the message. You can obviously write any code you want here.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <em>custom cloud function</em> simply returns the contactenated string.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Why typing ?</div>
<div class="paragraph">
<p>Typing is optional but recommended to have a well defined API. Thanks to typing,
ZetaPush is able to generate more accurate <a href="./reference.html#generate_api_documentation">documentation based on your code</a> and also
<a href="./reference.html#generate_sdks">generate mobile/web/IoT SDKs</a> from your code with the right types so it
makes developing your clients easier (for example, auto-completion can be used).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Tips about cloud functions</div>
<div class="paragraph">
<p>A <em>custom cloud service</em> can have as many <em>custom cloud functions</em> as you want.</p>
</div>
<div class="paragraph">
<p>A <em>custom cloud function</em> can have as many parameters as you want. Parameters can be anything: <code>string</code>, <code>number</code>,
<code>boolean</code>, <code>array</code> or <code>object</code>. You can code your function as you always do.</p>
</div>
<div class="paragraph">
<p>A <em>custom cloud function</em> can return anything including a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise">Promise</a>.
You can also write your code using <a href="https://javascript.info/async-await">async/await syntax</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Define several <em>custom cloud services</em></div>
<div class="paragraph">
<p>Obviously when your application grows, you need to split your <em>custom cloud service</em> into several classes in order
to make your API more understandable and more maintainable.</p>
</div>
<div class="paragraph">
<p>You can learn <a href="./reference.html#several_custom_cloud services">how to define several <em>custom cloud services</em></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You have now a <em>custom cloud service</em> that provides two <em>cloud functions</em>.
But until it is exposed, it can&#8217;t be called from outside of the worker.</p>
</div>
<div class="paragraph">
<p>The next section describes how you can expose your <em>custom cloud service</em>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_expose_a_em_custom_cloud_service_em"><a class="anchor" href="#_expose_a_em_custom_cloud_service_em"></a>Expose a <em>custom cloud service</em></h4>
<div class="paragraph">
<p>When you define a <em>custom cloud service</em> that you want to expose to the client,
you need to declare it. There are 2 cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only one <em>custom cloud service</em> exposed</p>
</li>
<li>
<p>Many <em>custom cloud services</em> exposed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this section we only address one <em>custom cloud service</em> exposed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to expose several <em>custom cloud services</em></div>
<div class="paragraph">
<p>You can also learn <a href="./reference.html#expose_several_custom_cloud_services">how to expose several <em>custom cloud services</em></a> in the advanced sections.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We follow npm conventions to indicate the entry point of your worker. Indeed, the <code>package.json</code> defines a property named <code>main</code>.
We use this property to indicate which file is the main file that declares the exposed <em>custom cloud service</em>.
By default, the main file is named <code>index.ts</code> and this file is placed in <code>worker</code> directory. So the <code>main</code>
property is by default <code>worker/index.ts</code>.</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="custom-cloud-service-entry-point.png" alt="custom cloud service entry point" width="678" height="161">
</div>
</div>
<div class="paragraph">
<p>Now that your <em>custom cloud service</em> is marked as the entry point, it can be exposed by ZetaPush.
However you still have a little change to make on your code:</p>
</div>
<div class="listingblock highlight-lines:1">
<div class="title">A more realistic <em>cloud function</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {                    <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b>
    constructor() {}

    helloWorld() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }

    saySomething(message: string, <span class="key">times</span>: number) {
        let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
        <span class="keyword">for</span>(let i=<span class="integer">0</span> ; i&lt;times ; i++) {
            fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>
        }
        <span class="keyword">return</span> fullMessage
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>export</code>: <a href="https://www.typescriptlang.org/docs/handbook/modules.html" target="_blank" rel="noopener">this is required by TypeScript</a>.
In fact, declaring a class in a file makes it private.
It means that if you have another <code>.ts</code> file and you want to import <code>HelloWorldAsCustomCloudService</code> declaration,
it won&#8217;t be possible without <code>export</code> keyword. This is for code encapsulation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>default</code>: <a href="https://www.typescriptlang.org/docs/handbook/modules.html#default-exports">TypeScript provides this keyword</a>.
When exposing only one <em>custom cloud service</em>, <code>default</code> tells the worker that there is only one class (only one
<em>custom cloud service</em> defined in the <code>index.ts</code>). So the worker can directly analyze it and instantiate it.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">How to expose several <em>custom cloud services</em></div>
<div class="paragraph">
<p>As seen above, you can also learn <a href="./reference.html#expose_several_custom_cloud_services">how to expose several <em>custom cloud services</em></a> in the advanced sections.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now your <em>custom cloud service</em> can be loaded by the ZetaPush worker and your <em>custom cloud service</em>
is automatically exposed.
It means that now a client can call the <em>cloud functions</em> defined in your <em>custom cloud service</em>.</p>
</div>
<div class="paragraph">
<p>The next section shows how to call a <em>cloud function</em> from a web page using pure JavaScript.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_a_em_custom_cloud_service_em_in_your_front"><a class="anchor" href="#_use_a_em_custom_cloud_service_em_in_your_front"></a>Use a <em>custom cloud service</em> in your front</h4>
<div class="paragraph">
<p>In this chapter we will see how to consume our <em>cloud functions</em> from a web page.
At the end of this example, we will have one button to call <code>helloWorld</code> <em>cloud function</em> and
one section with a message, a number of repetitions and a button to call <code>saySomething</code> <em>cloud function</em>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Mobile applications</div>
<div class="paragraph">
<p>Here we show how to create a web page that consumes our <em>custom cloud service</em>.</p>
</div>
<div class="paragraph">
<p>You can also create a mobile application for Android, iOS and Windows Phone as well
as code for a device. You can use any language you want for the client part.</p>
</div>
<div class="paragraph">
<p>By default we target web because it is currently the most used technology (even to build
some mobile applications using hybrid technologies).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As a reminder, here is the code of <em>custom cloud service</em> named <code>HelloWorldAsCustomCloudService</code>:</p>
</div>
<div class="listingblock">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {
    constructor() {}

    helloWorld() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }

    saySomething(message: string, <span class="key">times</span>: number) {
        let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
        <span class="keyword">for</span>(let i=<span class="integer">0</span> ; i&lt;times ; i++) {
            fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>
        }
        <span class="keyword">return</span> fullMessage
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_prepare_your_front_for_using_zetapush_client"><a class="anchor" href="#_prepare_your_front_for_using_zetapush_client"></a>Prepare your front for using ZetaPush client</h5>
<div class="paragraph">
<p>By convention the directory structure of a ZetaPush application is defined below. You place
the code of your web page in the <code>front</code> directory:</p>
</div>
<div class="listingblock">
<div class="title">Tree structure convention</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">hello-world
├── <em>.zetarc</em>
├── <em>.gitignore</em>
├── <strong>front</strong>
│   ├── ...
│   ├── <strong>index.js</strong>
│   └── <strong>index.html</strong>
├── <em>worker</em>
│   ├── ...
│   ├── ...
│   └── index.ts
├── <em>package.json</em>
├── <em>README.md</em>
└── <em>tsconfig.json</em></code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Other front files</div>
<div class="paragraph">
<p>For this example, we only need an HTML page and a JavaScript file. Needless to say that you can
have CSS files, images and anything you want too.</p>
</div>
<div class="paragraph">
<p>See more information about <a href="./reference.html#different_directory_structures">directory structure convention and how to adapt the structure</a>.</p>
</div>
<div class="paragraph">
<p>Moreover, you are not limited to write pure JavaScript code. You can also use any framework you want:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="./reference.html#develop_with_angular">Angular</a></p>
</li>
<li>
<p><a href="./reference.html#develop_with_react">React</a></p>
</li>
<li>
<p><a href="./reference.html#develop_with_vue">Vue.js</a></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For the example, we create an HTML page with a button to display the <em>HelloWorld</em> message in the page each time
the button is clicked:</p>
</div>
<div class="listingblock">
<div class="title">front/index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1.0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;title&gt;</span>Celtia<span class="tag">&lt;/title&gt;</span>
<span class="tag">&lt;/head&gt;</span>

<span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>hello()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>hello<span class="tag">&lt;/button&gt;</span>                    <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tag">&lt;ul</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result-container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/ul&gt;</span>                             <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@zetapush/client</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>  <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">./index.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>                          <i class="conum" data-value="3"></i><b>(3)</b>
<span class="tag">&lt;/body&gt;</span>

<span class="tag">&lt;/html&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We call <code>hello()</code> function that is defined later in <code>index.js</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Define a node that will display received messages</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We include the <code>client</code> module provided by ZetaPush</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We include a JavaScript file to distinguish HTML code from JavaScript code. All could be written in the HTML</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, in order to interact with ZetaPush cloud, we need to create a client instance
and to connect to the cloud:</p>
</div>
<div class="listingblock">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();     <i class="conum" data-value="1"></i><b>(1)</b>
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();        <i class="conum" data-value="2"></i><b>(2)</b>
<span class="comment">// Handle connection</span>
client.connect()                                    <i class="conum" data-value="3"></i><b>(3)</b>
  .then(() =&gt; {                                     <i class="conum" data-value="4"></i><b>(4)</b>
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  });</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use ZetaPushClient factory to instantiate a client. In this example, we ask for an anonymous connection (it means that actions are not bound to a particular user of your application)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Custom cloud service provides some functions that can be called from a client. For example, the <em>custom cloud service</em> exposes <code>helloWorld</code> and <code>saySomething</code> <em>cloud functions</em>.
Instead of having to write the signature of these functions in the client too, we simply use a JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy">Proxy</a>.
Therefore, you can directly interact with your custom cloud service without writing any pass-through code on the client side.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The client is ready, now connects it to the ZetaPush cloud.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Once the connection is established, the Promise is resolved and you can write some code in <code>then</code> callback.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Available client types</div>
<div class="paragraph">
<p><code>ZetaPushClient</code> provides several factories to get instances of a client according to
what you want to do. Here we are using a <code>WeakClient</code> instance but there are other
<a href="./reference.html#client_types">client types</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_call_code_hello_code_em_cloud_function_em"><a class="anchor" href="#_call_code_hello_code_em_cloud_function_em"></a>Call <code>hello</code> <em>cloud function</em></h5>
<div class="paragraph">
<p>Our client is ready and now we want to call <em>cloud function</em> named <code>helloWorld</code>, we add the following code:</p>
</div>
<div class="listingblock highlight-lines:11-14">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();
<span class="comment">// Handle connection</span>
client.connect()
  .then(() =&gt; {
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  });
<span class="comment">// Handle DOM events</span>
async <span class="keyword">function</span> <span class="function">hello</span>() {                                                                          <i class="conum" data-value="1"></i><b>(1)</b>
  const messageFromCloudFunction = await api.helloWorld();                                        <i class="conum" data-value="2"></i><b>(2)</b>
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messageFromCloudFunction}<span class="tag">&lt;/li&gt;</span><span class="error">`</span> <i class="conum" data-value="3"></i><b>(3)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Each time a user clicks on the button defined in the HTML, this method is called.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Calls the <code>helloWorld</code> <em>cloud function</em> and store the result in a variable.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add a new list item in the HTML page</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before running this sample, we improve our front in order to also understand
how to call a <em>cloud function</em> that has parameters.</p>
</div>
</div>
<div class="sect4">
<h5 id="_call_code_saysomething_code_em_cloud_function_em"><a class="anchor" href="#_call_code_saysomething_code_em_cloud_function_em"></a>Call <code>saySomething</code> <em>cloud function</em></h5>
<div class="paragraph">
<p>We add two inputs to be able to send values to the <code>saySomething</code> <em>cloud function</em>.
The first input is a text to repeat. The second input is the number of times to repeat the message.
Here is the updated code:</p>
</div>
<div class="listingblock highlight-lines:12-16">
<div class="title">front/index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
  <td class="code"><pre><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1.0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;title&gt;</span>Celtia<span class="tag">&lt;/title&gt;</span>
<span class="tag">&lt;/head&gt;</span>

<span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>hello()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>hello<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">border</span>: <span class="float">1px</span> <span class="value">solid</span> <span class="color">#ccc</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      Message: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">message-input</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>             <i class="conum" data-value="1"></i><b>(1)</b>
      Repeat: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repeat-input</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>     <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>saySeveralTimes()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>say something<span class="tag">&lt;/button&gt;</span>    <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;ul</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result-container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/ul&gt;</span>

    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@zetapush/client</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">./index.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>

<span class="tag">&lt;/html&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first input to enter a message</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The second input to enter the number of times to repeat the message</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A new button to call <code>saySeveralTimes()</code> function defined in <code>index.js</code></td>
</tr>
</table>
</div>
<div class="listingblock highlight-lines:15-20">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();
<span class="comment">// Handle connection</span>
client.connect()
  .then(() =&gt; {
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  });
<span class="comment">// Handle DOM events</span>
async <span class="keyword">function</span> <span class="function">hello</span>() {
  const messageFromCloudFunction = await api.helloWorld();
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messageFromCloudFunction}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>
}
async <span class="keyword">function</span> <span class="function">saySeveralTimes</span>() {                                                <i class="conum" data-value="1"></i><b>(1)</b>
  const message = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">message-input</span><span class="delimiter">'</span></span>).value;                 <i class="conum" data-value="2"></i><b>(2)</b>
  const repeat = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">repeat-input</span><span class="delimiter">'</span></span>).value;                   <i class="conum" data-value="3"></i><b>(3)</b>
  const messages = await api.saySomething(message, parseInt(repeat));             <i class="conum" data-value="4"></i><b>(4)</b>
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messages}<span class="tag">&lt;/li&gt;</span><span class="error">`</span> <i class="conum" data-value="5"></i><b>(5)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Each time a user clicks on the button 'say something' defined in the HTML, this method is called.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Reads the value of the input for getting the message.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Reads the value of the input for getting the number of times to display the message.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calls <code>saySomething</code> <em>cloud function</em> with parameters. Note that as second parameter is a number, we have to convert the string from
the input to a number using <code>parseInt</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Add a new list item in the HTML page containing the repeated messages</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now everything is ready to run our application.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
When you call a <em>cloud function</em> from the client, the result is always a Promise even if the <em>custom cloud function</em> is synchronous
because everything goes through the network.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_run_application"><a class="anchor" href="#_run_application"></a>Run application</h4>
<div class="paragraph">
<p>You have now defined a <em>custom cloud service</em> with one or several <em>cloud function(s)</em>. You
have also exposed your <em>custom cloud service</em>. So it is ready to be called from a client.
Your client is also ready to call the <em>custom cloud service</em>.</p>
</div>
<div class="paragraph">
<p>The next step is to start the project (both front and worker) using the ZetaPush <em>CLI</em>
on your computer.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Npm script aliases</div>
<div class="paragraph">
<p>Npm provides a handy feature
to run scripts provided by dependencies without needing to change your computer settings or
install the tool. ZetaPush defines npm <a href="https://medium.com/@mxstbr/npm-scripts-explained-f125e85eb378" target="_blank" rel="noopener">script aliases</a>
to run the ZetaPush <em>CLI</em> through npm.</p>
</div>
<div class="paragraph">
<p>See <a href="#_using_cli">for more information about the ways of using the CLI</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To start your worker and you front using the ZetaPush <em>CLI</em> through npm, you simply run:</p>
</div>
<div class="listingblock">
<div class="title">Start application (front and custom cloud services)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run start -- --serve-front</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>npm run start</code> is a script alias defined in the <code>package.json</code> file.
The command that is executed under the hood is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ zeta run --serve-front</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Run only the worker</div>
<div class="paragraph">
<p>It is also possible to <a href="./reference.html#run_worker_only">run only your worker</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Automatic injection of ZetaPush information in your front</div>
<div class="paragraph">
<p>If you look closely to the code we have written, there is no information about your application at all in this sample code (the <code>appName</code> defined in <code>.zetarc</code> is neither in HTML nor in JavaScript).
However, in order to interact with your application through the ZetaPush cloud, you need to provide the <code>appName</code>.</p>
</div>
<div class="paragraph">
<p>The ZetaPush <em>CLI</em> automatically injects the <code>appName</code> from <code>.zetarc</code>.</p>
</div>
<div class="paragraph">
<p>When you run your project locally, the local HTTP server that exposes the HTML page is lightly modified to include the <code>appName</code>.
This information is then automatically read by the ZetaPush client.</p>
</div>
<div class="paragraph">
<p>When your project is run in the cloud, the same principle is applied.</p>
</div>
<div class="paragraph">
<p>This way, you just use <code>.zetarc</code> file for your credentials and <code>appName</code> and avoid having to write them twice. This also avoids conflicts when you work
in team if you want different ZetaPush <code>appName</code> per developer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Now when we click the "hello" button, "Hello World" is displayed on the page.</strong></p>
</div>
<div class="imageblock center">
<div class="content">
<img src="call-zetapush-cloud-service.png" alt="call zetapush cloud service" width="739" height="431">
</div>
<div class="title">Figure 3. How it works ?</div>
</div>
<div class="paragraph">
<p>When you start your project locally, the first thing that happens is that your worker connects himself automatically to the ZetaPush cloud <span class="sequence-step">1</span> <span class="sequence-step">2</span>.</p>
</div>
<div class="paragraph">
<p>Then when you open your web browser, the connection from the client is established between the web page and the ZetaPush cloud <span class="sequence-step">3</span> <span class="sequence-step">4</span>.</p>
</div>
<div class="paragraph">
<p>When you click on the button, a message is sent through the opened connection in order to tell ZetaPush cloud to execute some
remote code <span class="sequence-step">5</span>. ZetaPush cloud routes the message to your worker <span class="sequence-step">6</span> (that is running on your machine here). The worker receives the message
and calls the <code>hello</code> <em>cloud function</em> <span class="sequence-step">7</span>.</p>
</div>
<div class="paragraph">
<p>The <em>cloud function</em> generates a result <span class="sequence-step">8</span>. The worker picks this result and transform it to a message <span class="sequence-step">9</span>. This message is then sent
to the ZetaPush cloud <span class="sequence-step">10</span>. The ZetaPush cloud routes the response message to the calling client <span class="sequence-step">11</span>. The client receives the message
and the response is parsed <span class="sequence-step">12</span> and available in your JavaScript.</p>
</div>
<div class="paragraph">
<p><strong>You can also try to enter a message and a number of repetitions and hit the "say something" button.</strong></p>
</div>
<div class="paragraph">
<p>The behavior is exactly the same. This time a message is sent to call the <em>cloud function</em> with also the parameters.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Serialization/deserailization between client and <em>custom cloud service</em></div>
<div class="paragraph">
<p>When you call a <em>cloud function</em> from the client, under the hood, the values are serialized in JSON.
This is understandable because everything goes through the network.</p>
</div>
<div class="paragraph">
<p>On the worker side, everything is deserialized by the worker and your <em>custom cloud service</em>
receives the values as they were written in the front side.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_compose_cloud_services"><a class="anchor" href="#_compose_cloud_services"></a>Compose cloud services</h4>
<div class="paragraph">
<p>You can compose <em>cloud services</em> either by using <em>built-in cloud services</em> provided by ZetaPush or
by using another of your <em>custom cloud services</em>.</p>
</div>
<div class="sect4">
<h5 id="_dependency_injection"><a class="anchor" href="#_dependency_injection"></a>Dependency injection</h5>
<div class="paragraph">
<p><a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank" rel="noopener">Dependency injection</a> is a powerful software technique that is
totally managed by the worker.</p>
</div>
<div class="paragraph">
<p>You don&#8217;t need to manage the creation of neither <em>built-in cloud services</em> nor your <em>custom cloud services</em>.
You just indicate in your code that you need a dependency and ZetaPush instantiates it
for you. The instantiated dependency is then injected everywhere the dependency is needed.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The dependency injection of ZetaPush uses Angular <a href="https://github.com/mgechev/injection-js" target="_blank" rel="noopener">injection-js</a> library.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To mark a <em>custom cloud service</em> injectable (meaning that can be automatically created by ZetaPush
and then injected everywhere the dependency is aksed),
you need to import the package <code>@zetapush/core</code> in order to use <code>Injectable</code> decorator.</p>
</div>
<div class="listingblock">
<div class="title">Install @zetapush/core using npm</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>$ npm install --save @zetapush/core</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the npm package is installed, you can import <code>Injectable</code> decorator and place it on your <em>custom cloud service</em>:</p>
</div>
<div class="listingblock highlight-lines:1,3">
<div class="title">Use @Injectable on a <em>custom cloud service</em></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;            <i class="conum" data-value="1"></i><b>(1)</b>

<span class="error">@</span>Injectable()                                           <i class="conum" data-value="2"></i><b>(2)</b>
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {
  constructor() {}

  helloWorld() {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
  }

  saySomething(message: string, <span class="key">times</span>: number) {
      let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
      <span class="keyword">for</span>(let i=<span class="integer">0</span> ; i&lt;times ; i++) {
          fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>
      }
      <span class="keyword">return</span> fullMessage
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import the ZetaPush module that contains core features for <em>custom cloud services</em> such as <code>injectable</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mark you <em>custom cloud service</em> candidate for dependency injection</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here we just indicate that this <em>custom cloud service</em> can have dependencies that
will be automatically injected and also that this <em>custom cloud service</em> can be injected
anywhere it is needed.</p>
</div>
<div class="paragraph">
<p>In the next sections, we will see in concrete terms how to use it to reuse either a <em>built-in cloud service</em>
or one of your <em>custom cloud services</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_use_built_in_em_cloud_service_em"><a class="anchor" href="#_use_built_in_em_cloud_service_em"></a>Use built-in <em>cloud service</em></h5>
<div class="paragraph">
<p>ZetaPush <em>built-in cloud services</em> are available in <code>@zetapush/platform-legacy</code> module.
Add this module to your <code>package.json</code> by running the following command:</p>
</div>
<div class="listingblock">
<div class="title">Install @zetapush/platform-legacy using npm</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
</pre></td>
  <td class="code"><pre>$ npm install --save @zetapush/platform-legacy</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">List of <em>cloud services</em> provided by ZetaPush</div>
<div class="paragraph">
<p>As a reminder, here is the <a href="./reference.html#builtin_cloud_services">list of <em>built-in cloud services</em></a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the following example, we will use the <code>Stack</code> <em>cloud service</em> provided by ZetaPush.
In our use-case, we want to put some data associated with the current timestamp and be able to list all stored data.</p>
</div>
<div class="paragraph">
<p>To do this, the <code>Stack</code> service already provides some methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>push({ <em>stack</em>: string, <em>data</em>: object });</code></p>
</li>
<li>
<p><code>list({ <em>stack</em>: string });</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">MyStorageService</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;  <i class="conum" data-value="1"></i><b>(1)</b>

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> MyStorageService {
  <span class="reserved">private</span> stackName = <span class="string"><span class="delimiter">'</span><span class="content">stack-example</span><span class="delimiter">'</span></span>;

  constructor(<span class="reserved">private</span> stack: Stack) {}              <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="comment">/**
   *  Store data with associated timestamp
   */</span>
  storeWithTimestamp(value: any) {
    <span class="keyword">return</span> <span class="local-variable">this</span>.stack.push({                        <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="key">stack</span>: <span class="local-variable">this</span>.stackName,
      <span class="key">data</span>: {
        value,
        <span class="key">timestamp</span>: Date.now()
      }
    });
  }

  <span class="comment">/**
   * List all stored data
   */</span>
  getAllData() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.stack.list({                        <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="key">stack</span>: <span class="local-variable">this</span>.stackName
    });
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We import the <code>Stack</code> service so that TypeScript knows it</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We ask ZetaPush to inject a dependency of type <code>Stack</code> (<code>stack</code> is an instance of <code>Stack</code>).
Here we use the <a href="https://kendaleiv.com/typescript-constructor-assignment-public-and-private-keywords/" target="_blank" rel="noopener">shorthand syntax</a> for declaring a constructor parameter as well as a property.
So the property <code>this.stack</code> is defined and is initialized with <code>stack</code> parameter.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Calls the <code>Stack</code> service to store data (method <code>push</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calls the <code>Stack</code> service to list data (method <code>list</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The example defines a <em>custom cloud service</em> named <code>MyStorageService</code> that provides two <em>cloud functions</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>storeWithTimestamp</code> that receives a value from a client and calls the <code>Stack</code> service to
store received value (<code>value</code> parameter) as well as the current timestamp (using <code>Date.now()</code>)</p>
</li>
<li>
<p><code>getAllData</code> that has no parameters and calls <code>Stack</code> service to get all previsouly stored
pairs of <code>&lt;value, timestamp&gt;</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The most important part to understand is in the <code>constructor</code>. As described before,
the example uses dependency injection. You simply tell ZetaPush that you need a dependency of type <code>Stack</code>.
You don&#8217;t create it in your <em>custom cloud service</em> because it is not the responsibility of
your <em>custom cloud service</em> to create the <code>Stack</code> service. Instead, you let ZetaPush
handle the creation. Thanks to <code>@Injectable</code> decorator, ZetaPush detects that you have
a <em>custom cloud services</em> with needed dependencies. ZetaPush understands that you need a <code>Stack</code>
instance so it instantiates it before instantiating your <em>custom cloud service</em>. Then
ZetaPush instantiates your <em>custom cloud service</em> by providing, as the first argument of your
constructor here, the instance of <code>Stack</code>.</p>
</div>
<div class="paragraph">
<p>This behavior avoids you to have complex code to instantiate <em>built-in cloud services</em>. Moreover,
if you have several <em>custom cloud services</em> that are using the <code>Stack</code> service, thanks to
dependency injection, there will be only one instance shared between your <em>custom cloud services</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_use_another_em_custom_cloud_service_em"><a class="anchor" href="#_use_another_em_custom_cloud_service_em"></a>Use another <em>custom cloud service</em></h5>
<div class="paragraph">
<p>In this example, we will have 2 <em>custom cloud services</em>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Calendar</code>: Utils function to return the current date</p>
</li>
<li>
<p><code>HelloWorldService</code>: Basic example using <code>Calendar</code> <em>cloud function</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The first <em>custom cloud service</em> (<code>Calendar</code>) is defined in the file <code>worker/calendar.js</code>.</p>
</div>
<div class="listingblock">
<div class="title">worker/calendar.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
</pre></td>
  <td class="code"><pre><span class="reserved">export</span> <span class="reserved">class</span> Calendar {
  getNow() { <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="keyword">return</span> <span class="keyword">new</span> Date().toLocalDateString(<span class="string"><span class="delimiter">'</span><span class="content">fr-FR</span><span class="delimiter">'</span></span>);
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The only <em>cloud function</em> of the <code>Calendar</code> service</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, we have the <code>HelloWorldWithDateService</code> that use our <code>Calendar</code> service. It is defined in the file <code>worker/index.ts</code>.</p>
</div>
<div class="listingblock highlight-lines:7,13">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Calendar } from <span class="string"><span class="delimiter">'</span><span class="content">./calendar</span><span class="delimiter">'</span></span>;        <i class="conum" data-value="1"></i><b>(1)</b>

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldWithDateService {
  constructor(                                <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="reserved">private</span> calendar: Calendar
  ) {}
  <span class="comment">/**
   * Return 'Hello World' with current date
   */</span>
  helloWorldWithDate() {
    <span class="keyword">return</span> <span class="error">`</span>Hello world at <span class="predefined">$</span>{<span class="local-variable">this</span>.calendar.getNow()}<span class="error">`</span>;
 }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We import the <code>Calendar</code> service from the <code>worker/calendar.ts</code> file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>calendar</code> is an instance of <code>Calendar</code> and <code>this.calendar</code> is initialized with <code>calendar</code> value</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As for <em>built-in cloud services</em>, dependency injection works for your <em>custom cloud services</em>.
Here it was an example</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Private <em>custom cloud service</em></div>
<div class="paragraph">
<p>In this example, we still have only one <em>custom cloud service</em> exposed.</p>
</div>
<div class="paragraph">
<p>One <code>HelloWorldWithDateService</code> is exposed and delegates some work to <code>Calendar</code>.
<code>Calendar</code> is not exposed and can&#8217;t be directly called from a client. So it can be considered
as a private <em>custom cloud service</em>.</p>
</div>
<div class="paragraph">
<p>Sometimes you may want to <a href="./reference.html#expose_several_cloud_services">expose several <em>custom cloud services</em></a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Shared module of <em>custom cloud services</em></div>
<div class="paragraph">
<p>As you can see, a <em>custom cloud service</em> is no more than just a standard class with methods written
in TypeScript. If you want to develop reusable <em>custom cloud services</em> that could be
used in different applications, you can do it easily by following standards.
Actually, you can <a href="./reference.html#shared_module">just create a npm module</a> and import it like we do with <code>@zetapush/core</code> or
<code>@zetapush/platform-legacy</code>.</p>
</div>
<div class="paragraph">
<p>You can also import any existing library that is available in the community.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_develop_fast"><a class="anchor" href="#_develop_fast"></a>Develop fast</h3>
<div class="sect3">
<h4 id="_hot_reload"><a class="anchor" href="#_hot_reload"></a>Hot reload</h4>
<div class="paragraph">
<p>In order to improve productivity, ZetaPush provides <strong>hot reload</strong> feature.
Once you have started your application on your computer, you just focus on writing your code.</p>
</div>
<div class="paragraph">
<p>Each time you make a change in your <em>custom cloud services</em> code, ZetaPush detects the change
and reload your <em>custom cloud services</em> code. The time to wait for code to be ready is drastically reduced so
you can develop really faster thanks to this feature.</p>
</div>
<div class="paragraph">
<p>As front part is simply HTML and JavaScript, the local HTTP server always serves the
latest version of your code. The cache is explicitly disabled in local development.</p>
</div>
<div class="sect4">
<h5 id="_test_the_feature"><a class="anchor" href="#_test_the_feature"></a>Test the feature</h5>
<div class="paragraph">
<p>To test this feature, we will reuse the <strong>HelloWorldAsCustomCloudService</strong> sample.
As a reminder, here is the code:</p>
</div>
<div class="paragraph tab-container">
<p>HelloWorldAsCustomCloudService</p>
</div>
<div class="paragraph tab">
<p>worker/index.ts</p>
</div>
<div class="listingblock">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {
    constructor() {}

    helloWorld() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World</span><span class="delimiter">&quot;</span></span>;
    }

    saySomething(message: string, <span class="key">times</span>: number) {
        let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
        <span class="keyword">for</span>(let i=<span class="integer">0</span> ; i&lt;times ; i++) {
            fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>
        }
        <span class="keyword">return</span> fullMessage
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph tab">
<p>front/index.html</p>
</div>
<div class="listingblock">
<div class="title">front/index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td>
  <td class="code"><pre><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1.0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;title&gt;</span>Celtia<span class="tag">&lt;/title&gt;</span>
<span class="tag">&lt;/head&gt;</span>

<span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>hello()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>hello<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">border</span>: <span class="float">1px</span> <span class="value">solid</span> <span class="color">#ccc</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      Message: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">message-input</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      Repeat: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repeat-input</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>saySeveralTimes()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>say something<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;ul</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result-container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/ul&gt;</span>

    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@zetapush/client</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">./index.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>

<span class="tag">&lt;/html&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph tab">
<p>front/index.js</p>
</div>
<div class="listingblock">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();
<span class="comment">// Handle connection</span>
client.connect()
  .then(() =&gt; {
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  });
<span class="comment">// Handle DOM events</span>
async <span class="keyword">function</span> <span class="function">hello</span>() {
  const messageFromCloudFunction = await api.helloWorld();
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messageFromCloudFunction}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>
}
async <span class="keyword">function</span> <span class="function">saySeveralTimes</span>() {
  const message = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">message-input</span><span class="delimiter">'</span></span>).value;
  const repeat = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">repeat-input</span><span class="delimiter">'</span></span>).value;
  const messages = await api.saySomething(message, parseInt(repeat));
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messages}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph tab-container-end">
<p>-</p>
</div>
<div class="paragraph">
<p>Now start your application by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run start -- --serve-front</code></pre>
</div>
</div>
<div class="paragraph">
<p>Click on 'hello' button, the message "Hello World" appears in the web page.</p>
</div>
<div class="sect5">
<h6 id="_simple_change_in_code_of_your_em_custom_cloud_service_em"><a class="anchor" href="#_simple_change_in_code_of_your_em_custom_cloud_service_em"></a>Simple change in code of your <em>custom cloud service</em></h6>
<div class="paragraph">
<p>Your application is started locally. Now we will test this feature by updating your code.
Update the <code>worker/index.ts</code> file as following:</p>
</div>
<div class="listingblock highlight-lines:8 collapse-lines:10-17">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {
    constructor() {}

    helloWorld() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World !!!</span><span class="delimiter">&quot;</span></span>;                       <i class="conum" data-value="1"></i><b>(1)</b>
    }

    saySomething(message: string, <span class="key">times</span>: number) {
        let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
        <span class="keyword">for</span>(let i=<span class="integer">0</span> ; i&lt;times ; i++) {
            fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>
        }
        <span class="keyword">return</span> fullMessage
    }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add " !!!" at the end of the string</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save the file and check your terminal. You should see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">⠋ Reloading worker...
[INFO] Worker is up!</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check that the code is really updated by clicking on the 'hello' button.
Now you see that "Hello World !!!" is displayed in the web page.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">No change is needed on the front</div>
<div class="paragraph">
<p>You don&#8217;t need to reload the web page or to reconnect the client to the ZetaPush cloud.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_change_code_of_your_front"><a class="anchor" href="#_change_code_of_your_front"></a>Change code of your front</h6>
<div class="paragraph">
<p>To demonstrate a change in your front, we will update the code of the
<code>saySeveralTimes</code> function:</p>
</div>
<div class="listingblock highlight-lines:18 collapse-lines:1-14">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();
<span class="comment">// Handle connection</span>
client.connect()
  .then(() =&gt; {
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  });
<span class="comment">// Handle DOM events</span>
async <span class="keyword">function</span> <span class="function">hello</span>() {
  const messageFromCloudFunction = await api.helloWorld();
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messageFromCloudFunction}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>
}
async <span class="keyword">function</span> <span class="function">saySeveralTimes</span>() {
  const message = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">message-input</span><span class="delimiter">'</span></span>).value;
  const repeat = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">repeat-input</span><span class="delimiter">'</span></span>).value;
  const messages = await api.saySomething(message + <span class="string"><span class="delimiter">'</span><span class="content"> - </span><span class="delimiter">'</span></span>, parseInt(repeat));               <i class="conum" data-value="1"></i><b>(1)</b>
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messages}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We add ' - ' on the message parameter</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save your file and reload your web page. Enter a message ("hello" for example) and click on 'say something' button.
You should see "hello - hello - " (if you have chosen 2 repetitions).</p>
</div>
</div>
<div class="sect5">
<h6 id="_use_a_em_cloud_service_em_on_the_fly"><a class="anchor" href="#_use_a_em_cloud_service_em_on_the_fly"></a>Use a <em>cloud service</em> on the fly</h6>
<div class="paragraph">
<p>As your application grows, you will need to use other <em>built-in cloud services</em> or <em>custom cloud services</em>.</p>
</div>
<div class="paragraph">
<p>We will improve our <em>custom cloud service</em> to use the <code>Stack</code> <em>built-in cloud service</em> to store messages.
First <code>Stack</code> service is provided by <code>@zetapush/platform-legacy</code> module. So you have to install it.
You can keep your application running in your terminal and open another terminal in the same folder.
Execute this command in the new terminal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm install --save @zetapush/platform-legacy</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now import <code>Stack</code> service in your code and use it:</p>
</div>
<div class="listingblock highlight-lines:2,6,17-26,30-37">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;          <i class="conum" data-value="1"></i><b>(1)</b>

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {
  constructor(<span class="reserved">private</span> stack: Stack) {}                      <i class="conum" data-value="2"></i><b>(2)</b>

  helloWorld() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>;
  }

  async saySomething(message: string, <span class="key">times</span>: number) {
    let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
    <span class="keyword">for</span> (let i = <span class="integer">0</span>; i &lt; times; i++) {
      fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>;
    }
    <span class="comment">// store source information (message and times)</span>
    <span class="comment">// and generated information (fullMessage)</span>
    await <span class="local-variable">this</span>.stack.push({                                 <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>,
      <span class="key">data</span>: {
        message,
        times,
        fullMessage
      }
    });
    <span class="keyword">return</span> fullMessage;
  }

  async getStoredMessages() {                               <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="comment">// get all values</span>
    const response = await <span class="local-variable">this</span>.stack.list({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>
    });
    <span class="comment">// get only useful part (message, times, fullMessage)</span>
    <span class="keyword">return</span> response.result ? response.result.content.map((item) =&gt; item.data) : [];
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import the module <code>@zetapush/platform-legacy</code> that we just installed with npm</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Indicate that we need a dependency of type <code>Stack</code> that will be provided by ZetaPush worker</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add some code to store the messages. Here we store both received parameters and the generated message</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>A new <em>cloud function</em> in order to display what&#8217;s in the database</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can save your file and if you look in your terminal, you can see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">⠋ Reloading worker...
[INFO] Create services [ [ { itemId: 'stack',
      businessId: 'v79ivn00l',
      deploymentId: 'stack_0',
      description: 'stack',
      options: {},
      forbiddenVerbs: [Array],
⠴ Reloading worker...
[INFO] Worker is up!</code></pre>
</div>
</div>
<div class="paragraph">
<p>To ensure that everything works fine, you need to update your front:</p>
</div>
<div class="listingblock highlight-lines:8,19,21-25 collapse-lines:1-4">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();
<span class="comment">// Handle connection</span>
client.connect().then(() =&gt; {
  console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  <span class="keyword">return</span> displayAllMessages();                                                                 <i class="conum" data-value="1"></i><b>(1)</b>
});
<span class="comment">// Handle DOM events</span>
async <span class="keyword">function</span> <span class="function">hello</span>() {
  const messageFromCloudFunction = await api.helloWorld();
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messageFromCloudFunction}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>;
}
async <span class="keyword">function</span> <span class="function">saySeveralTimes</span>() {
  const message = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">message-input</span><span class="delimiter">'</span></span>).value;
  const repeat = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">repeat-input</span><span class="delimiter">'</span></span>).value;
  const messages = await api.saySomething(message + <span class="string"><span class="delimiter">'</span><span class="content"> - </span><span class="delimiter">'</span></span>, parseInt(repeat));
  await displayAllMessages();                                                                  <i class="conum" data-value="2"></i><b>(2)</b>
}
async <span class="keyword">function</span> <span class="function">displayAllMessages</span>() {                                                          <i class="conum" data-value="3"></i><b>(3)</b>
  const storedMessages = await api.getStoredMessages();                                        <i class="conum" data-value="4"></i><b>(4)</b>
  const messagesAsString = storedMessages.map((msg) =&gt; <span class="error">`</span><span class="tag">&lt;li&gt;</span>${JSON.stringify(msg)}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>);     <i class="conum" data-value="5"></i><b>(5)</b>
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML = messagesAsString.join(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);           <i class="conum" data-value="6"></i><b>(6)</b>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Load all messages once connected.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Replace code that writes <code>fullMessage</code> in the HTML by a call to the function below.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define another function to display all messages.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Call the <em>cloud function</em> to retrieve all stored messages in database. This is the
important part of the code because it calls a <em>cloud function</em> freshly written.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Convert object of values to a JSON string.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Write all stored messages in the HTML.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Save your file and reload your web page. You can enter a message ("foo" for example) and a number
of repetitions (5 for example). Then hit the 'say something' button. Now you will see something like:</p>
</div>
<div class="paragraph">
<p><code>{"message":"foo - ","times":5,"fullMessage":"foo - foo - foo - foo - foo - "}</code></p>
</div>
<div class="paragraph">
<p>This means that your <em>custom cloud service</em> has been reloaded and the <code>Stack</code> service
is really used. You can ensure that by reloading the web page, you will see the message
displayed in the web page.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Import npm module</div>
<div class="paragraph">
<p>As you can see, you can add a npm module even if your application is running
and then import it in your code. The hot reload takes effect only when
you update the code handled by the ZetaPush worker (i.e. your <em>custom cloud services</em> code).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Hot reload with <em>built-in cloud services</em></div>
<div class="paragraph">
<p>Thanks to dependency injection, ZetaPush worker can detect if a <em>built-in cloud service</em>
is newly needed as a dependency. In fact, the worker keeps tracking of all dependencies to <em>built-in cloud services</em>
and check if a new service is asked. If so, the worker creates it on ZetaPush cloud,
instantiates it, and injects it everywhere it is needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="title">Hot reload on other files</div>
<div class="paragraph">
<p>Currently, if you update <code>.zetarc</code> or you update a configuration file or any other file
that is not code loaded by the worker, your <em>custom cloud services</em> won&#8217;t be automatically reloaded.</p>
</div>
<div class="paragraph">
<p>This feature will be supported in a future version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_auto_completion"><a class="anchor" href="#_auto_completion"></a>Auto-completion</h4>
<div class="paragraph">
<p>You can use an IDE for speeding up your development:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://code.visualstudio.com/" target="_blank" rel="noopener">Visual Studio Code</a></p>
</li>
<li>
<p><a href="https://www.jetbrains.com/webstorm/" target="_blank" rel="noopener">WebStorm</a></p>
</li>
<li>
<p><a href="https://atom.io/" target="_blank" rel="noopener">Atom</a></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thanks to typing provided by TypeScript, these IDE can provide accurate auto-completion when
you develop your <em>custom cloud services</em>.</p>
</div>
<div class="paragraph">
<p>That&#8217;s why auto-completion also works with ZetaPush <em>built-in cloud services</em>:</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="./images//auto-completion/method.png" alt="method">
</div>
<div class="title">Figure 4. Auto-completion on <em>cloud functions</em></div>
</div>
<div class="imageblock center">
<div class="content">
<img src="./images//auto-completion/parameters.png" alt="parameters">
</div>
<div class="title">Figure 5. Auto-completion on <em>cloud functions</em> parameters</div>
</div>
<div class="imageblock center">
<div class="content">
<img src="./images//auto-completion/returned-values.png" alt="returned values">
</div>
<div class="title">Figure 6. Auto-completion on <em>cloud functions</em> return value</div>
</div>
<div class="paragraph">
<p>As you can see, in addition to auto-completion, documentation of <em>cloud services</em> is
also available.</p>
</div>
</div>
<div class="sect3">
<h4 id="_log_from_a_em_custom_cloud_service_em"><a class="anchor" href="#_log_from_a_em_custom_cloud_service_em"></a>Log from a <em>custom cloud service</em></h4>
<div class="sect4">
<h5 id="_log_using_local_console"><a class="anchor" href="#_log_using_local_console"></a>Log using local console</h5>
<div class="paragraph">
<p>NodeJS provides <code>console</code> object that you can use in your code. For example, update
the code of your <em>custom cloud service</em> to add some logs:</p>
</div>
<div class="listingblock highlight-lines:13,18,29">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService {
  constructor(<span class="reserved">private</span> stack: Stack) {}

  helloWorld() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>;
  }

  async saySomething(message: string, <span class="key">times</span>: number) {
    console.log(<span class="string"><span class="delimiter">'</span><span class="content">message=</span><span class="delimiter">'</span></span>, message, <span class="string"><span class="delimiter">'</span><span class="content">times=</span><span class="delimiter">'</span></span>, times);
    let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
    <span class="keyword">for</span> (let i = <span class="integer">0</span>; i &lt; times; i++) {
      fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>;
    }
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">fullMessage=</span><span class="delimiter">'</span></span>, fullMessage);
    <span class="comment">// store source information (message and times)</span>
    <span class="comment">// and generated information (fullMessage)</span>
    const response = await <span class="local-variable">this</span>.stack.push({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>,
      <span class="key">data</span>: {
        message,
        times,
        fullMessage
      }
    });
    console.debug(<span class="string"><span class="delimiter">'</span><span class="content">stack.push response=</span><span class="delimiter">'</span></span>, response);
    <span class="keyword">return</span> fullMessage;
  }

  async getStoredMessages() {
    <span class="comment">// get all values</span>
    const response = await <span class="local-variable">this</span>.stack.list({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>
    });
    <span class="comment">// get only useful part (message, times, fullMessage)</span>
    <span class="keyword">return</span> response.result ? response.result.content.map((item) =&gt; item.data) : [];
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Running your application and hitting 'say something' button with a "hello" message and 5 repetitions,
your terminal will print something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[INFO] Worker is up!  ‌
message= hello -  times= 5                                                          <i class="conum" data-value="1"></i><b>(1)</b>
fullMessage= hello -                                                                <i class="conum" data-value="2"></i><b>(2)</b>
hello -
hello -
hello -
hello -

stack.push response= { contextId: '3303/4rU/4934',                                  <i class="conum" data-value="3"></i><b>(3)</b>
  owner: 'v79ivn00l:root',
  stack: 'messages',
  ts: 1544096927555,
  guid: '///+mHymsL1sq8jZZa1F2g==',
  data:
   { message: 'hello - ',
     times: 5,
     fullMessage: 'hello - \nhello - \nhello - \nhello - \nhello - \n' } }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The first <code>console.log</code> that displays parameters</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The first <code>console.debug</code> that displays the generated message</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The second <code>console.debug</code> that displays the response of the <code>Stack</code> service</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, you can have any number of parameters you want and of any type.
For objects, the <code>console</code> will display it as JSON string.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Logs in production</div>
<div class="paragraph">
<p>Logging using <code>console</code> only logs in your terminal. It means that nothing is neither written to a file
nor sent to a logging server. You will then loose all logs if you close your terminal.</p>
</div>
<div class="paragraph">
<p>However, when you will later publish your application on the ZetaPush cloud, everything
written in standard and error outputs will be available in the
<a href="./reference.html#logs_in_web_console">ZetaPush web console</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Levels and colors in local console</div>
<div class="paragraph">
<p>ZetaPush also provides a logger object that can be useful to distinguish levels.
Levels are explicitly written (for example <code>[INFO]</code>). Each level has its own
name displayed in color and may have a color for the message too.
This is useful to quickly view what is important.</p>
</div>
<div class="paragraph">
<p>You can learn <a href="./reference.html#local_logger">how to use the local logger</a>.</p>
</div>
<div class="paragraph">
<p>Moreover, thanks to levels you <a href="./reference.html#verbosity_level">can start your application with a particular level</a>
so levels below the selected level are not displayed at all.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_log_using_zetapush_em_built_in_cloud_service_em"><a class="anchor" href="#_log_using_zetapush_em_built_in_cloud_service_em"></a>Log using ZetaPush <em>built-in cloud service</em></h5>
<div class="paragraph">
<p>In order to provide a logger with more features, ZetaPush provides the <a href="./reference.html#_logs"><code>Logs</code> cloud service</a>.
Thanks to this service you can provide more context to your log entries (a logger name, levels, tags or an identifier, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>The service <a href="./reference.html#log_service">can be used directly</a> but code for logging may be a quite verbose if you provide
all information manually.</p>
</div>
<div class="paragraph">
<p>So ZetaPush also provides an automatic logging feature that magically adds:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the name of the called <em>cloud function</em></p>
</li>
<li>
<p>the parameter values of the called <em>cloud function</em></p>
</li>
<li>
<p>the returned value of the called <em>cloud function</em></p>
</li>
<li>
<p>the current date</p>
</li>
<li>
<p>the unique identifier of the request</p>
</li>
<li>
<p>which user has made the call</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It also automatically logs all calls to <em>builtin cloud services</em> that could be
made in the <em>cloud function</em>.</p>
</div>
<div class="listingblock highlight-lines:1,5,6,19,30">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable, RequestContextAware, RequestContext } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;     <i class="conum" data-value="1"></i><b>(1)</b>
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService <span class="reserved">implements</span> RequestContextAware {  <i class="conum" data-value="2"></i><b>(2)</b>
  requestContext!: RequestContext;                                                    <i class="conum" data-value="3"></i><b>(3)</b>

  constructor(<span class="reserved">private</span> stack: Stack) {}

  helloWorld() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>;
  }

  async saySomething(message: string, <span class="key">times</span>: number) {
    let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
    <span class="keyword">for</span> (let i = <span class="integer">0</span>; i &lt; times; i++) {
      fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>;
    }
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">fullMessage=</span><span class="delimiter">'</span></span>, fullMessage);                           <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="comment">// store source information (message and times)</span>
    <span class="comment">// and generated information (fullMessage)</span>
    const response = await <span class="local-variable">this</span>.stack.push({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>,
      <span class="key">data</span>: {
        message,
        times,
        fullMessage
      }
    });
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">stack.push response=</span><span class="delimiter">'</span></span>, response);                      <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="keyword">return</span> fullMessage;
  }

  async getStoredMessages() {
    <span class="comment">// get all values</span>
    const response = await <span class="local-variable">this</span>.stack.list({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>
    });
    <span class="comment">// get only useful part (message, times, fullMessage)</span>
    <span class="keyword">return</span> response.result ? response.result.content.map((item) =&gt; item.data) : [];
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import <code>RequestContext</code> and <code>RequestContextAware</code> from <code>@zetapush/core</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Implements <code>RequestContextAware</code> to indicate that we use <code>requestContext</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>requestContext</code> magic property that is automatically provided by the worker. No need to initialize it.
The <code>!</code> character is here to guide TypeScript otherwise there is a compilation error because
<code>requestContext</code> is not initialized.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Calls logger of <code>requestContext</code> to log <code>fullMessage</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Calls logger of <code>requestContext</code> to log <code>response</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">RequestContextAware</div>
<div class="paragraph">
<p>Implementing <code>RequestContextAware</code> is totally optional but recommended even if it works
without it.
If you work in team, it indicates to other developers that
the use of <code>requestContext</code> attribute is intentional and that it is not dead code.
Moreover, implementing this interface gives you some documentation about <code>requestContext</code>
attribute.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Definite Assignment Assertions</div>
<div class="paragraph">
<p>TypeScript checks that a
<a href="https://github.com/Microsoft/TypeScript/wiki/What&#8217;s-new-in-TypeScript#strict-class-initialization" target="_blank" rel="noopener">class attribute is initialized</a>.</p>
</div>
<div class="paragraph">
<p>As <code>requestContext</code> is an injected attribute, its value is not directly initialized in your class.
The <a href="https://github.com/Microsoft/TypeScript/wiki/What&#8217;s-new-in-TypeScript#definite-assignment-assertions" target="_blank" rel="noopener">Definite Assignment Assertions</a>
allows to explicitly indicate to TypeScript type checker that
the attribute is initialized outside of the class (using <code>!</code> character after attribute name).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Internally, the logger uses the <em>Logs cloud service</em>. The logs are by default sent to
ZetaPush cloud and then available in ZetaPush web console. The ZetaPush worker is aware
of the current context. So every log entry is enhanced with current context call.</p>
</div>
<div class="paragraph">
<p>For the example, start your application and hit the 'say something' button.
Here is the result of the logs in the web console:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Advanced usage</div>
<div class="paragraph">
<p>You can find more information about <a href="./reference.html#log_with_requestcontext">advance usage of the logger provided by <code>RequestContext</code></a>
in reference documentation.</p>
</div>
<div class="paragraph">
<p>You can also learn how to <a href="./reference.html#persist_logs">persist logs</a> and how to <a href="./reference.html#custom_logging_server">send logs to a custom log server</a>.</p>
</div>
<div class="paragraph">
<p>You can learn how to <a href="./reference.html#use_custom_tags">use custom tags</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Integration with libraries</div>
<div class="paragraph">
<p>NodeJS community provides several logging libraries like <a href="https://github.com/winstonjs/winston" target="_blank" rel="noopener">winston</a>,
<a href="https://github.com/trentm/node-bunyan" target="_blank" rel="noopener">bunyan</a>, <a href="https://github.com/expressjs/morgan" target="_blank" rel="noopener">morgan</a>, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Currently, you can use them to log into the local console but as said before, the current
context is not automatically provided.
In the futur, ZetaPush will provide bridges to fully support those libraries to automatically
provide the current context.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_debug_a_em_custom_cloud_service_em"><a class="anchor" href="#_debug_a_em_custom_cloud_service_em"></a>Debug a <em>custom cloud service</em></h4>
<div class="sect4">
<h5 id="_debug_your_application_with_vscode"><a class="anchor" href="#_debug_your_application_with_vscode"></a>Debug your application with VSCode</h5>
<div class="paragraph">
<p>VSCode provide a powerfull debugging feature <a href="https://code.visualstudio.com/docs/editor/debugging" class="bare">https://code.visualstudio.com/docs/editor/debugging</a>.</p>
</div>
<div class="paragraph">
<p>Add a launch configuration with the following structure.</p>
</div>
<div class="listingblock">
<div class="title">Configure .vscode/launch.json file</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td>
  <td class="code"><pre>{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0.2.0</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">configurations</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">zeta run</span><span class="delimiter">&quot;</span></span>,                                       <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">node</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">request</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">launch</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">program</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${workspaceRoot}/node_modules/.bin/zeta</span><span class="delimiter">&quot;</span></span>,     <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="key"><span class="delimiter">&quot;</span><span class="content">stopOnEntry</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">sourceMaps</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">args</span><span class="delimiter">&quot;</span></span>: [                                                 <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="string"><span class="delimiter">&quot;</span><span class="content">run</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">--serve-front</span><span class="delimiter">&quot;</span></span>
      ],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">cwd</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${workspaceRoot}</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">console</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">internalConsole</span><span class="delimiter">&quot;</span></span>
    }
  ]
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Launch configuration name (the name you want)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Path to local zeta <em>CLI</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>zeta command arguments</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Under the hood, VSCode runs a NodeJS process that runs <code>node_modules/.bin/zeta</code> script
with two parameters <code>run</code> and <code>--serve-front</code>.</p>
</div>
<div class="paragraph">
<p>It is exactly the same as doing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ node_modules/.bin/zeta run --serve-front</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>VSCode may use a different version of the NodeJS you use in an external terminal.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the configuration is ready, you can start your application in debug mode as indicated
in <a href="https://code.visualstudio.com/docs/editor/debugging" target="_blank" rel="noopener">VSCode documentation</a>.</p>
</div>
<div class="paragraph">
<p>In the following picture, we show that the debugger stops in the code of your <em>custom cloud service</em>.
You can also see the values of the parameters and now you can execute the code step by step.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images//debug/run-vscode-debugger.png" alt="Run VSCode debugger">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_debug_your_application_with_intellij_based_ide"><a class="anchor" href="#_debug_your_application_with_intellij_based_ide"></a>Debug your application with IntelliJ based IDE</h5>
<div class="paragraph">
<p>Intellij&#8217;s WebStorm provides a powerfull debugging feature <a href="https://blog.jetbrains.com/webstorm/2018/01/how-to-debug-with-webstorm/" class="bare">https://blog.jetbrains.com/webstorm/2018/01/how-to-debug-with-webstorm/</a>.</p>
</div>
<div class="paragraph">
<p>On the top menu, select Run &#8594; Edit Configurations</p>
</div>
<div class="paragraph">
<p>then select a new NodeJs Template :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Node interpreter : path to nodeJS executable.</p>
</li>
<li>
<p>Node parameters : must be "node_modules/.bin/zeta".</p>
</li>
<li>
<p>Working directory : path to your project.</p>
</li>
<li>
<p>Javascript file : should be blank.</p>
</li>
<li>
<p>Application parameters : zeta command to launch, with optionals flags.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images//debug/webstorm-debug.png" alt="Configure WebStorm Debug">
</div>
</div>
<div class="paragraph">
<p>You can now use Intellij in debug mode with breakpoints and all the debugs features.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_test_a_em_custom_cloud_service_em"><a class="anchor" href="#_test_a_em_custom_cloud_service_em"></a>Test a <em>custom cloud service</em></h4>
<div class="sect4">
<h5 id="_test_your_em_custom_cloud_service_em"><a class="anchor" href="#_test_your_em_custom_cloud_service_em"></a>Test your <em>custom cloud service</em></h5>
<div class="paragraph">
<p>Testing not only ensures that you don&#8217;t make regression but also can help you code faster.</p>
</div>
<div class="sect5">
<h6 id="_unit_testing"><a class="anchor" href="#_unit_testing"></a>Unit testing</h6>
<div class="paragraph">
<p>Unit testing is a great way to provide quickly a feature without losing time
on going back to the right execution context. The component (or <code>class</code> here)
is tested alone (all dependencies are mocked).</p>
</div>
<div class="paragraph">
<p>This section shows that you don&#8217;t need ZetaPush for unit testing and that you can
use any testing library you want. For the example, we use <a href="https://jasmine.github.io/" target="_blank" rel="noopener">jasmine</a> because
in addition to testing tools, it also provides basic mocking features.
For the example, we will reuse our <strong>HelloWorldAsCustomCloudService</strong> and we will improve it.</p>
</div>
<div class="paragraph">
<p>As a reminder, here is the complete code of the <em>custom cloud service</em> and front:</p>
</div>
<div class="paragraph tab-container">
<p>HelloWorldAsCustomCloudService</p>
</div>
<div class="paragraph tab">
<p>worker/index.ts</p>
</div>
<div class="listingblock">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable, RequestContextAware, RequestContext } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService <span class="reserved">implements</span> RequestContextAware {
  requestContext!: RequestContext;

  constructor(<span class="reserved">private</span> stack: Stack) {}

  helloWorld() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>;
  }

  async saySomething(message: string, <span class="key">times</span>: number) {
    let fullMessage = <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>;
    <span class="keyword">for</span> (let i = <span class="integer">0</span>; i &lt; times; i++) {
      fullMessage += <span class="error">`</span><span class="predefined">$</span>{message}<span class="error">\</span>n<span class="error">`</span>;
    }
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">fullMessage=</span><span class="delimiter">'</span></span>, fullMessage);
    <span class="comment">// store source information (message and times)</span>
    <span class="comment">// and generated information (fullMessage)</span>
    const response = await <span class="local-variable">this</span>.stack.push({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>,
      <span class="key">data</span>: {
        message,
        times,
        fullMessage
      }
    });
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">stack.push response=</span><span class="delimiter">'</span></span>, response);
    <span class="keyword">return</span> fullMessage;
  }

  async getStoredMessages() {
    <span class="comment">// get all values</span>
    const response = await <span class="local-variable">this</span>.stack.list({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>
    });
    <span class="comment">// get only useful part (message, times, fullMessage)</span>
    <span class="keyword">return</span> response.result ? response.result.content.map((item) =&gt; item.data) : [];
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph tab">
<p>front/index.html</p>
</div>
<div class="listingblock">
<div class="title">front/index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td>
  <td class="code"><pre><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;head&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1.0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;title&gt;</span>Celtia<span class="tag">&lt;/title&gt;</span>
  <span class="tag">&lt;/head&gt;</span>

  <span class="tag">&lt;body&gt;</span>
    <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>hello()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>hello<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;div</span> <span class="attribute-name">style</span>=<span class="string"><span class="delimiter">&quot;</span><span class="key">border</span>: <span class="float">1px</span> <span class="value">solid</span> <span class="color">#ccc</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      Message: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">message-input</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span> Repeat: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">repeat-input</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;button</span> <span class="attribute-name">onclick</span>=<span class="string"><span class="delimiter">&quot;</span>saySeveralTimes()<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>say something<span class="tag">&lt;/button&gt;</span>
    <span class="tag">&lt;/div&gt;</span>
    <span class="tag">&lt;ul</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result-container</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/ul&gt;</span>

    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@zetapush/client</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
    <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">./index.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
  <span class="tag">&lt;/body&gt;</span>
<span class="tag">&lt;/html&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph tab">
<p>front/index.js</p>
</div>
<div class="listingblock">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td>
  <td class="code"><pre><span class="comment">// Create new ZetaPush Client</span>
const client = <span class="keyword">new</span> ZetaPushClient.WeakClient();
<span class="comment">// Create a proxy to invoked worker methods</span>
const api = client.createProxyTaskService();
<span class="comment">// Handle connection</span>
client.connect().then(() =&gt; {
  console.debug(<span class="string"><span class="delimiter">'</span><span class="content">onConnectionEstablished</span><span class="delimiter">'</span></span>);
  <span class="keyword">return</span> updateAllMessages();
});
<span class="comment">// Handle DOM events</span>
async <span class="keyword">function</span> <span class="function">hello</span>() {
  const messageFromCloudFunction = await api.helloWorld();
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML += <span class="error">`</span><span class="tag">&lt;li&gt;</span>${messageFromCloudFunction}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>;
}
async <span class="keyword">function</span> <span class="function">saySeveralTimes</span>() {
  const message = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">message-input</span><span class="delimiter">'</span></span>).value;
  const repeat = document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">repeat-input</span><span class="delimiter">'</span></span>).value;
  const messages = await api.saySomething(message + <span class="string"><span class="delimiter">'</span><span class="content"> - </span><span class="delimiter">'</span></span>, parseInt(repeat));
  await updateAllMessages();
}
async <span class="keyword">function</span> <span class="function">updateAllMessages</span>() {
  const storedMessages = await api.getStoredMessages();
  const messagesAsString = storedMessages.map((msg) =&gt; <span class="error">`</span><span class="tag">&lt;li&gt;</span>${JSON.stringify(msg)}<span class="tag">&lt;/li&gt;</span><span class="error">`</span>);
  document.getElementById(<span class="string"><span class="delimiter">'</span><span class="content">result-container</span><span class="delimiter">'</span></span>).innerHTML = messagesAsString.join(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph tab-container-end">
<p>-</p>
</div>
<div class="paragraph">
<p>Firstly, we add <code>jasmine</code> by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm install --save-dev jasmine                    <i class="conum" data-value="1"></i><b>(1)</b>
$ node node_modules/jasmine/bin/jasmine init        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Add <code>jasmine</code> module in your project (save it in <code>devDependencies</code> using <code>--save-dev</code> argument)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add some files required by jasmine to your project (<code>spec</code> folder is created)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We want to test <code>saySomething</code> <em>cloud function</em> to ensure that the generated message
corresponds to what we really want. Let&#8217;s start by writing the skeleton of the tests. Create the file
<code>spec/hello-world-custom-cloud-service/say-something.spec.js</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">spec/hellp-world-custom-cloud-service/say-something.spec.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td>
  <td class="code"><pre>describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">HelloWorldCustomCloudService.</span><span class="delimiter">&quot;</span></span>, () =&gt; {
  beforeEach(() =&gt; {
    <span class="local-variable">this</span>.helloWorldService = <span class="predefined-constant">null</span>;                                          <i class="conum" data-value="1"></i><b>(1)</b>
  });

  <span class="comment">/**
   * Nominal case with a message repeated 1 time
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 1)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 1 time</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">1</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Nominal case with a message repeated 5 times
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 5)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 5 times separated by new lines</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">5</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Edge case with a message but nothing written due to no repetition
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 0)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns empty message</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Edge case with a message that is not a string
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething(5, 2)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 2 times</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="integer">5</span>, <span class="integer">2</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="content">5</span><span class="content">\n</span><span class="content">5</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Exception case with a string for the number of repetitions
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', '5')</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 5 times separated by new lines</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      <span class="keyword">try</span> {
        await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">5</span><span class="delimiter">'</span></span>);
        fail(<span class="string"><span class="delimiter">'</span><span class="content">should have failed</span><span class="delimiter">'</span></span>);
      } <span class="keyword">catch</span>(e) {
        expect(e.message).toBe(<span class="string"><span class="delimiter">'</span><span class="content">Only integer values are allowed for number of repetitions</span><span class="delimiter">'</span></span>);
      }
    });
  });
});</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We need an instance of your <em>custom cloud service</em> here. We will see later how to do that
in unit testing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have prepared the tests and the expectations. Now we need to instantiate
the <strong>HelloWorldCustomCloudService</strong> for testing it. However this function has a
dependency to the <code>Stack</code> <em>built-in cloud service</em>.
So normally, to test it we need the ZetaPush worker and the ZetaPush cloud to instantiate
this service. But in unit testing, we mock <strong>all</strong> dependencies to test only
<strong>HelloWorldCustomCloudService</strong>:</p>
</div>
<div class="listingblock highlight-lines:1-2,6-11">
<div class="title">spec/hellp-world-custom-cloud-service/say-something.spec.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td>
  <td class="code"><pre>const customCloudService = require(<span class="string"><span class="delimiter">'</span><span class="content">../../worker/index</span><span class="delimiter">'</span></span>);                         <i class="conum" data-value="1"></i><b>(1)</b>
const HelloWorldAsCustomCloudService = customCloudService[<span class="string"><span class="delimiter">'</span><span class="content">default</span><span class="delimiter">'</span></span>];             <i class="conum" data-value="2"></i><b>(2)</b>

describe(<span class="string"><span class="delimiter">'</span><span class="content">HelloWorldCustomCloudService.</span><span class="delimiter">'</span></span>, () =&gt; {
  beforeEach(() =&gt; {
    const mockedStack = jasmine.createSpyObj(<span class="string"><span class="delimiter">'</span><span class="content">Stack</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">push</span><span class="delimiter">'</span></span>]);                  <i class="conum" data-value="3"></i><b>(3)</b>
    const mockedRequestContext = {                                                <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="key">logger</span>: jasmine.createSpyObj(<span class="string"><span class="delimiter">'</span><span class="content">RequestContextLogger</span><span class="delimiter">'</span></span>, [<span class="string"><span class="delimiter">'</span><span class="content">debug</span><span class="delimiter">'</span></span>])
    };
    <span class="local-variable">this</span>.helloWorldService = <span class="keyword">new</span> HelloWorldAsCustomCloudService(mockedStack);     <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="local-variable">this</span>.helloWorldService.requestContext = mockedRequestContext;                 <i class="conum" data-value="6"></i><b>(6)</b>
  });

  <span class="comment">/**
   * Nominal case with a message repeated 1 time
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 1)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 1 time</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">1</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Nominal case with a message repeated 5 times
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 5)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 5 times separated by new lines</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">5</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Edge case with a message but nothing written due to no repetition
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 0)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns empty message</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">0</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Edge case with a message that is not a string
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething(5, 2)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 2 times</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      const result = await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="integer">5</span>, <span class="integer">2</span>);
      expect(result).toBe(<span class="string"><span class="delimiter">'</span><span class="content">5</span><span class="content">\n</span><span class="content">5</span><span class="delimiter">'</span></span>);
    });
  });

  <span class="comment">/**
   * Exception case with a string for the number of repetitions
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', '5')</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">&quot;</span><span class="content">returns the message written 5 times separated by new lines</span><span class="delimiter">&quot;</span></span>, async () =&gt; {
      <span class="keyword">try</span> {
        await <span class="local-variable">this</span>.helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">5</span><span class="delimiter">'</span></span>);
        fail(<span class="string"><span class="delimiter">'</span><span class="content">should have failed</span><span class="delimiter">'</span></span>);
      } <span class="keyword">catch</span>(e) {
        expect(e.message).toBe(<span class="string"><span class="delimiter">'</span><span class="content">Only integer values are allowed for number of repetitions</span><span class="delimiter">'</span></span>);
      }
    });
  });
});</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import code of your <em>custom cloud service</em>. As it is declared in <code>index.ts</code> with <code>export default</code>,
the <code>require</code> imports an object <code>{default: HelloWorldCustomCloudService}</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Get only a reference to <code>HelloWorldCustomCloudService</code> class</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Use jasmine to create a mock object of <code>Stack</code> <em>cloud service</em> with a method <code>push</code> that does nothing</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create an object that has a property <code>logger</code> with a mocked <code>debug</code> method. This object is used
to mock <code>requestContext</code> attribute.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Instantiate the <code>HelloWorldCustomCloudService</code> <em>cloud service</em> with the mocked instance of <code>Stack</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Manually inject the mocked <code>requestContext</code> (as the worker would do automatically in ZetaPush context)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now our cloud service is ready to be tested. We can run jasmine but as the <em>custom cloud service</em>
is written in TypeScript, we need to run jasmine with <a href="https://github.com/TypeStrong/ts-node" target="_blank" rel="noopener">ts-node</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ node -r ts-node/register node_modules/jasmine/bin/jasmine</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">TypeScript</div>
<div class="paragraph">
<p>As your project is initialized for using TypeScript, <code>ts-node</code> is already available
in your project (imported by the <code>@zetapush/cli</code> module).</p>
</div>
<div class="paragraph">
<p>You can also write your <a href="./reference.html#test_in_typescript">tests directly in TypeScript</a> to benefit from auto-completion and
type checking in your test suites too.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Run directly from VSCode</div>
<div class="paragraph">
<p>You can configure VSCode to run your tests. In the main menu, click on <span class="menuseq"><b class="menu">Debug</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Add Configuration&#8230;&#8203;</b></span>:</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="./images//debug/add-debug-menu.png" alt="add debug menu">
</div>
</div>
<div class="paragraph">
<p>Add these lines in the <code>launch.json</code> file:</p>
</div>
<div class="listingblock highlight-lines:7-22">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json">{
  <span class="error">/</span><span class="error">/</span> <span class="error">U</span><span class="error">s</span><span class="error">e</span> <span class="error">I</span><span class="error">n</span><span class="error">t</span><span class="error">e</span><span class="error">l</span><span class="error">l</span><span class="error">i</span><span class="error">S</span><span class="error">e</span><span class="error">n</span><span class="error">s</span><span class="error">e</span> <span class="error">t</span><span class="error">o</span> <span class="error">l</span><span class="error">e</span><span class="error">a</span><span class="error">r</span><span class="error">n</span> <span class="error">a</span><span class="error">b</span><span class="error">o</span><span class="error">u</span><span class="error">t</span> <span class="error">p</span><span class="error">o</span><span class="error">s</span><span class="error">s</span><span class="error">i</span><span class="error">b</span><span class="error">l</span><span class="error">e</span> <span class="error">a</span><span class="error">t</span><span class="error">t</span><span class="error">r</span><span class="error">i</span><span class="error">b</span><span class="error">u</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">.</span>
  <span class="error">/</span><span class="error">/</span> <span class="error">H</span><span class="error">o</span><span class="error">v</span><span class="error">e</span><span class="error">r</span> <span class="error">t</span><span class="error">o</span> <span class="error">v</span><span class="error">i</span><span class="error">e</span><span class="error">w</span> <span class="error">d</span><span class="error">e</span><span class="error">s</span><span class="error">c</span><span class="error">r</span><span class="error">i</span><span class="error">p</span><span class="error">t</span><span class="error">i</span><span class="error">o</span><span class="error">n</span><span class="error">s</span> <span class="error">o</span><span class="error">f</span> <span class="error">e</span><span class="error">x</span><span class="error">i</span><span class="error">s</span><span class="error">t</span><span class="error">i</span><span class="error">n</span><span class="error">g</span> <span class="error">a</span><span class="error">t</span><span class="error">t</span><span class="error">r</span><span class="error">i</span><span class="error">b</span><span class="error">u</span><span class="error">t</span><span class="error">e</span><span class="error">s</span><span class="error">.</span>
  <span class="error">/</span><span class="error">/</span> <span class="error">F</span><span class="error">o</span><span class="error">r</span> <span class="error">m</span><span class="error">o</span><span class="error">r</span><span class="error">e</span> <span class="error">i</span><span class="error">n</span><span class="error">f</span><span class="error">o</span><span class="error">r</span><span class="error">m</span><span class="error">a</span><span class="error">t</span><span class="error">i</span><span class="error">o</span><span class="error">n</span>, <span class="error">v</span><span class="error">i</span><span class="error">s</span><span class="error">i</span><span class="error">t</span>: <span class="error">h</span><span class="error">t</span><span class="error">t</span><span class="error">p</span><span class="error">s</span>:<span class="error">/</span><span class="error">/</span><span class="error">g</span><span class="error">o</span><span class="error">.</span><span class="error">m</span><span class="error">i</span><span class="error">c</span><span class="error">r</span><span class="error">o</span><span class="error">s</span><span class="error">o</span><span class="error">f</span><span class="error">t</span><span class="error">.</span><span class="error">c</span><span class="error">o</span><span class="error">m</span><span class="error">/</span><span class="error">f</span><span class="error">w</span><span class="error">l</span><span class="error">i</span><span class="error">n</span><span class="error">k</span><span class="error">/</span><span class="error">?</span><span class="error">l</span><span class="error">i</span><span class="error">n</span><span class="error">k</span><span class="error">i</span><span class="error">d</span><span class="error">=</span><span class="integer">830387</span>
  <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0.2.0</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">configurations</span><span class="delimiter">&quot;</span></span>: [
    {
      <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">tests</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">node</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">request</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">launch</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">stopOnEntry</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">sourceMaps</span><span class="delimiter">&quot;</span></span>: <span class="value">true</span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">runtimeArgs</span><span class="delimiter">&quot;</span></span>: [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">-r</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">ts-node/register</span><span class="delimiter">&quot;</span></span>
      ],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">args</span><span class="delimiter">&quot;</span></span>: [
        <span class="string"><span class="delimiter">&quot;</span><span class="content">node_modules/jasmine/bin/jasmine.js</span><span class="delimiter">&quot;</span></span>
      ],
      <span class="key"><span class="delimiter">&quot;</span><span class="content">cwd</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">${workspaceRoot}</span><span class="delimiter">&quot;</span></span>,
      <span class="key"><span class="delimiter">&quot;</span><span class="content">console</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">integratedTerminal</span><span class="delimiter">&quot;</span></span>
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can select the <code>tests</code> launch configuration and hit <kbd>F5</kbd>. You can
have every information directly in your editor.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you run the tests, you will see that only one test succeeds. This is normal because if you
look closely at the tests, you can see that the expected behavior is to have no
new line at the end of the string. So the code of the <em>custom cloud service</em> doesn&#8217;t
match the expected behavior. Let&#8217;s fix the code of the <em>cloud function</em>:</p>
</div>
<div class="listingblock highlight-lines:15-19">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable, RequestContextAware, RequestContext } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService <span class="reserved">implements</span> RequestContextAware {
  requestContext!: RequestContext;

  constructor(<span class="reserved">private</span> stack: Stack) {}

  helloWorld() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>;
  }

  async saySomething(message: string, <span class="key">times</span>: number) {
    let parts = [];
    <span class="keyword">for</span> (let i = <span class="integer">0</span>; i &lt; times; i++) {
      parts.push(<span class="error">`</span><span class="predefined">$</span>{message}<span class="error">`</span>);
    }
    let fullMessage = parts.join(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">fullMessage=</span><span class="delimiter">'</span></span>, fullMessage);
    <span class="comment">// store source information (message and times)</span>
    <span class="comment">// and generated information (fullMessage)</span>
    const response = await <span class="local-variable">this</span>.stack.push({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>,
      <span class="key">data</span>: {
        message,
        times,
        fullMessage
      }
    });
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">stack.push response=</span><span class="delimiter">'</span></span>, response);
    <span class="keyword">return</span> fullMessage;
  }

  async getStoredMessages() {
    <span class="comment">// get all values</span>
    const response = await <span class="local-variable">this</span>.stack.list({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>
    });
    <span class="comment">// get only useful part (message, times, fullMessage)</span>
    <span class="keyword">return</span> response.result ? response.result.content.map((item) =&gt; item.data) : [];
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now if you run again the tests, you can see that 4 tests are succeeding and only 1 left in
failure. The test in failure is normal because we expect a particular message if
times parameter is not a number.
We can fix it by updating the code of the <em>cloud function</em> like this:</p>
</div>
<div class="listingblock highlight-lines:15-17">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> { Injectable, RequestContextAware, RequestContext } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Stack } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>;

<span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> HelloWorldAsCustomCloudService <span class="reserved">implements</span> RequestContextAware {
  requestContext!: RequestContext;

  constructor(<span class="reserved">private</span> stack: Stack) {}

  helloWorld() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">'</span><span class="content">Hello World</span><span class="delimiter">'</span></span>;
  }

  async saySomething(message: string, <span class="key">times</span>: number) {
    <span class="keyword">if</span> (<span class="keyword">typeof</span> times !== <span class="string"><span class="delimiter">'</span><span class="content">number</span><span class="delimiter">'</span></span>) {
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string"><span class="delimiter">'</span><span class="content">Only integer values are allowed for number of repetitions</span><span class="delimiter">'</span></span>);
    }
    let parts = [];
    <span class="keyword">for</span> (let i = <span class="integer">0</span>; i &lt; times; i++) {
      parts.push(<span class="error">`</span><span class="predefined">$</span>{message}<span class="error">`</span>);
    }
    let fullMessage = parts.join(<span class="string"><span class="delimiter">'</span><span class="content">\n</span><span class="delimiter">'</span></span>);
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">fullMessage=</span><span class="delimiter">'</span></span>, fullMessage);
    <span class="comment">// store source information (message and times)</span>
    <span class="comment">// and generated information (fullMessage)</span>
    const response = await <span class="local-variable">this</span>.stack.push({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>,
      <span class="key">data</span>: {
        message,
        times,
        fullMessage
      }
    });
    <span class="local-variable">this</span>.requestContext.logger.debug(<span class="string"><span class="delimiter">'</span><span class="content">stack.push response=</span><span class="delimiter">'</span></span>, response);
    <span class="keyword">return</span> fullMessage;
  }

  async getStoredMessages() {
    <span class="comment">// get all values</span>
    const response = await <span class="local-variable">this</span>.stack.list({
      <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span>
    });
    <span class="comment">// get only useful part (message, times, fullMessage)</span>
    <span class="keyword">return</span> response.result ? response.result.content.map((item) =&gt; item.data) : [];
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can run again the tests and everything is ok.
You can notice that running unit tests allows to develop faster because you just
need to run everything at once instead of entering messages and number of repeats
manually in your web browser several times.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Provide behavior to mocks</div>
<div class="paragraph">
<p>In this sample, we only show how to define objects and methods that do nothing.
Obviously mocking systems also allow to define a <a href="./reference.html#advanced_mocks">behavior for calls on mock objects</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_local_integration_test"><a class="anchor" href="#_local_integration_test"></a>Local integration test</h6>
<div class="paragraph">
<p>Testing a <em>custom cloud service</em> alone is good but you often need to tests
interactions between several <em>cloud services</em> or interaction with <em>built-in cloud services</em>.
ZetaPush provides tools to help you write integration tests and to setup
a ZetaPush context for your tests.</p>
</div>
<div class="paragraph">
<p>First, you need to install the <code>@zetapush/testing</code> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm install --save-dev @zetapush/testing</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, as done before we will write the skeleton of the tests.
Create a new test file <code>spec/hellp-world-custom-cloud-service/say-something.it.spec.js</code> with the following content:</p>
</div>
<div class="listingblock">
<div class="title">spec/hellp-world-custom-cloud-service/say-something.it.spec.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td>
  <td class="code"><pre>describe(<span class="string"><span class="delimiter">'</span><span class="content">HelloWorldAsCustomCloudService.</span><span class="delimiter">'</span></span>, () =&gt; {
  beforeEach(async () =&gt; {                                                          <i class="conum" data-value="1"></i><b>(1)</b>
  }, <span class="integer">30</span> * <span class="integer">1000</span>);                                                                    <i class="conum" data-value="2"></i><b>(2)</b>

  <span class="comment">/**
   * Nominal case with a message repeated 5 times
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 5)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">'</span><span class="content">stores the message, the number of repetitions and the generated message</span><span class="delimiter">'</span></span>,
      async () =&gt; {                                                                 <i class="conum" data-value="3"></i><b>(3)</b>
          <span class="comment">// call the method to test</span>
          await helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">5</span>);                         <i class="conum" data-value="4"></i><b>(4)</b>

          <span class="comment">// check that everything works fine</span>
          const storedMessages = await helloWorldService.getStoredMessages();       <i class="conum" data-value="5"></i><b>(5)</b>
          expect(storedMessages.length).toBe(<span class="integer">1</span>);                                    <i class="conum" data-value="6"></i><b>(6)</b>
          expect(storedMessages[<span class="integer">0</span>]).toEqual({                                       <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="key">message</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>,
            <span class="key">times</span>: <span class="integer">5</span>,
            <span class="key">fullMessage</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="delimiter">'</span></span>
          });
      },
      <span class="integer">5</span> * <span class="integer">60</span> * <span class="integer">1000</span>                                                                 <i class="conum" data-value="8"></i><b>(8)</b>
    );
  });
});</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Empty for now, we will fill it later. Don&#8217;t forget the <code>async</code> keyword.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Change the default timeout of jasmine for test preparation (we will see why later)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Run the test using async/await syntax to have a cleaner code</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The call to the <em>cloud function</em> to test</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Retrieve all previously stored messages</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Assertion to ensure there is exactly one entry</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Assertion to ensure that the stored value is correct</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Change the default timeout of jasmine for this test (we will see why later)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have defined what we need to test. Now to make it work, we need to run
the test in a ZetaPush worker. As a reminder, using ZetaPush <em>built-in cloud services</em>
requires a creation of the services on the ZetaPush cloud. As a reminder too,
ZetaPush worker detects needed dependencies and instantiate them.
In the context of a test, we also need these mechanisms in order to instantiate
the dependencies and to inject them in our test.</p>
</div>
<div class="paragraph">
<p>ZetaPush testing module provides several utilities to define an execution context
and to run the test in that context. Add the following code to your test:</p>
</div>
<div class="listingblock highlight-lines:1-4,8-18,27-29,42">
<div class="title">spec/hellp-world-custom-cloud-service/say-something.spec.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td>
  <td class="code"><pre>const { given, runInWorker } = require(<span class="string"><span class="delimiter">'</span><span class="content">@zetapush/testing</span><span class="delimiter">'</span></span>);
const customCloudService = require(<span class="string"><span class="delimiter">'</span><span class="content">../../worker/index</span><span class="delimiter">'</span></span>);
const HelloWorldAsCustomCloudService = customCloudService[<span class="string"><span class="delimiter">'</span><span class="content">default</span><span class="delimiter">'</span></span>];
const { Stack } = require(<span class="string"><span class="delimiter">'</span><span class="content">@zetapush/platform-legacy</span><span class="delimiter">'</span></span>);

describe(<span class="string"><span class="delimiter">'</span><span class="content">HelloWorldAsCustomCloudService.</span><span class="delimiter">'</span></span>, () =&gt; {
  beforeEach(async () =&gt; {
    await given()                                                       <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="comment">/**/</span> .credentials()                                               <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="comment">/*   */</span> .fromZetarc()                                             <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="comment">/*   */</span> .and()
      <span class="comment">/**/</span> .worker()                                                    <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="comment">/*   */</span> .testModule(() =&gt; ({                                      <i class="conum" data-value="5"></i><b>(5)</b>
        <span class="key">expose</span>: [HelloWorldAsCustomCloudService]
      }))
      <span class="comment">/*   */</span> .dependencies(HelloWorldAsCustomCloudService, Stack)      <i class="conum" data-value="6"></i><b>(6)</b>
      <span class="comment">/**/</span> .and()
      .apply(<span class="local-variable">this</span>);                                                     <i class="conum" data-value="7"></i><b>(7)</b>
  }, <span class="integer">5</span> * <span class="integer">60</span> * <span class="integer">1000</span>);

  <span class="comment">/**
   * Nominal case with a message repeated 5 times
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 5)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">'</span><span class="content">stores the message, the number of repetitions and the generated message</span><span class="delimiter">'</span></span>,
      async () =&gt; {
        await runInWorker(<span class="local-variable">this</span>, async (helloWorldService, stack) =&gt; {   <i class="conum" data-value="8"></i><b>(8)</b>
          <span class="comment">// clean the stack before adding into it</span>
          await stack.purge({ <span class="key">stack</span>: <span class="string"><span class="delimiter">'</span><span class="content">messages</span><span class="delimiter">'</span></span> });                     <i class="conum" data-value="9"></i><b>(9)</b>

          <span class="comment">// call the method to test</span>
          await helloWorldService.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">5</span>);

          <span class="comment">// check that everything works fine</span>
          const storedMessages = await helloWorldService.getStoredMessages();
          expect(storedMessages.length).toBe(<span class="integer">1</span>);
          expect(storedMessages[<span class="integer">0</span>]).toEqual({
            <span class="key">message</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>,
            <span class="key">times</span>: <span class="integer">5</span>,
            <span class="key">fullMessage</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="delimiter">'</span></span>
          });
        });
      },
      <span class="integer">5</span> * <span class="integer">60</span> * <span class="integer">1000</span>
    );
  });

  afterEach(async () =&gt; {                                               <i class="conum" data-value="10"></i><b>(10)</b>
    await autoclean(<span class="local-variable">this</span>);                                              <i class="conum" data-value="11"></i><b>(11)</b>
  });
});</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>given</code> utility is designed to prepare the test context. This is the entry
point to a fluent API</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>credentials</code> is used to configure the source of the ZetaPush credentials and application information.
This information is required in order to be able to connect to the ZetaPush cloud</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>fromZetarc</code> indicates that the test must load <code>developerLogin</code>, <code>developerPassword</code>, <code>platformUrl</code> and <code>appName</code>
from your <code>.zetarc</code> file. It means that it automatically loads the credentials you are using
in development</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>worker</code> is used to configure the ZetaPush worker context for the test</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>testModule</code> indicates that the worker context must provide a standalone module.
For now, we have only seen a <em>custom cloud service</em> exposed. But in fact, it is an implicit
<a href="./reference.html#modules">ZetaPush module</a>. In our test, we define a really simple module that exposes the
<em>custom cloud service</em>. Basically, it means that your test is exactly like your <code>index.ts</code></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Indicate which dependencies will be injected in the test (see parameters of <code>runInWorker</code>).</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Now all the preparation of the test context is ready, <code>apply</code> really executes building of test context.
It also stores some information needed by the test in <code>this</code> (the current jasmine test context)</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td><code>runInWorker</code> as its name says, runs the code in the worker context started for the test.
Note the <code>this</code> as first argument that is used to retrieve information set by <code>given().apply(this)</code>.
The callback takes here two parameters. Those parameters correspond to the dependencies declared
in <code>given().worker().dependencies()</code></td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>As <code>Stack</code> service is the same between the development and every test execution,
the <code>Stack</code> may already contain some items. That&#8217;s why we force to empty the stack before executing the real test.</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>After each test don&#8217;t forget to clean everything</td>
</tr>
<tr>
<td><i class="conum" data-value="11"></i><b>11</b></td>
<td>ZetaPush provides test utility to automatically remove everything that has been done
by the <code>given()</code> (like stopping properly the worker).</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Timeouts</div>
<div class="paragraph">
<p>As execution context needs the ZetaPush worker to create <em>built-in cloud services</em>,
the default jasmine timeout is too low: 5 seconds only for both preparation of the test
(<code>beforeEach</code>) and the execution of the test (<code>it</code>). We need to increase it because
the creation may take more than 5 seconds.</p>
</div>
<div class="paragraph">
<p>In the example, we set to 30 seconds for preparation and 5 minutes for the test.
Hopefully, ZetaPush worker doesn&#8217;t need 5 minutes to start and execute code.
But 5 minutes can be useful to place a debugger in the code and to
debug the test execution.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now you can run the test using jasmine too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ node -r ts-node/register node_modules/jasmine/bin/jasmine</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that contrary to unit testing, the worker prepares the test context.
You should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[TRACE] register [ 'queue_0', { port: 2999, type: 'queue_0' } ] ‌
[TRACE] register [ 'ZETAPUSH_HTTP_SERVER', { port: 2999, type: 'queue_0' } ] ‌
[TRACE] confPath [ '/tmp/foobar/' ] ‌
[TRACE] externalConfPath [ undefined ] ‌
[TRACE] env [ LocalServerRegistryZetaPushContext {
    config:
     { developerLogin: '*******',
       developerPassword: '*******',
       platformUrl: 'https://celtia.zetapush.com/zbo/pub/business',
       appName: '********' },
    registry: LocalServerRegistry { servers: [Object] },
    urlProvider: [Function] } ] ‌
[TRACE] analyzed providers [ [ { provide: [Function: TestDeclarationWrapper],
      useClass: [Function: TestDeclarationWrapper] },
    { provide: [Function: Environment], useValue: [Object] },
    { provide: [Function: ConfigurationProperties],
      useValue: [PriorizedConfigurationProperties] },
    { provide: [Function: ZetaPushContext],
      useValue: [LocalServerRegistryZetaPushContext] },
    { provide: [Function: Stack], useValue: [Stack] },
    { provide: [Function: HelloWorldAsCustomCloudService],
      useClass: [Function: HelloWorldAsCustomCloudService] },
    { provide: [Function: Wrapper],
      useFactory: [Function: useFactory],
      deps: [Array] } ] ] ‌
[TRACE] analyzed platformServices [ [ [Function: Stack] ] ] ‌
[TRACE] bootstrap layers [ [ [ [Function: HelloWorldAsCustomCloudService],
      [Function: Wrapper],
      [Function: TestDeclarationWrapper] ],
    [],
    [ [Function: HelloWorldAsCustomCloudService],
      [Function: Stack] ] ] ] ‌
[LOG] GET [ 'https://celtia.zetapush.com:/zbo/orga/item/list/v79ivn00l',
  undefined ] ‌
[LOG] Provisioning [ [Function: Stack] ] ‌
[TRACE] instantiate [ { '0':
     HelloWorldAsCustomCloudService {
       stack: [Stack],
       [Symbol(ZetaPush.CloudServiceInstance)]: true },
    ZetaTest:
     TestDeclarationWrapper {
       wrapper: [Wrapper],
       [Symbol(ZetaPush.CloudServiceInstance)]: true },
    bootLayers: [ [Array], [], [Array] ] } ] ‌
[TRACE] Worker successfully started</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Verbosity level in tests</div>
<div class="paragraph">
<p>The test is by default started with high verbosity in order to let you know
what happens in ZetaPush worker. Therefore, if something fails you can have enough information
to know where and why it has failed.</p>
</div>
<div class="paragraph">
<p>You can <a href="./reference.html#verbosity_level_in_tests">change the verbosity level</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following sequence diagram explains how it works:</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="local-integration-testing.png" alt="local integration testing" width="1306" height="1592">
</div>
<div class="title">Figure 7. How it works ?</div>
</div>
<div class="paragraph">
<p>Jasmine executes the code of the test and starts by running code of the <code>beforeEach</code> function.
<code>given()</code> fluent API is called <span class="sequence-step">1</span> but does nothing. In fact, <code>given()</code> is just the
entry point to the fluent API.
<code>given().credentials()</code>, <code>given().project()</code> and <code>given().worker()</code> only store information
about what you need for your test <span class="sequence-step">3</span> <span class="sequence-step">4</span>
<span class="sequence-step">5</span> <span class="sequence-step">6</span> <span class="sequence-step">7</span> <span class="sequence-step">8</span>. Nothing is initialized here. We don&#8217;t show
all calls to the fluent API in the sequence diagram because it is the same principle, we just
store information about what you need in your test.
As all needed information is grabbed, you ask the testing utilities to prepare the
context by calling <code>apply(this)</code> <span class="sequence-step">9</span>. The testing utilities prepare the context
by asking to the worker to start your "virtual" module defined with <code>testModule</code> <span class="sequence-step">10</span>.
The worker connects to the ZetaPush cloud using your credentials <span class="sequence-step">11</span>
<span class="sequence-step">12</span>.
As a reminder, we used <code>given().credentials().fromZetarc()</code> so it will use
the credentials defined in the <code>.zetarc</code> file directly.
Then the worker resolves all needed dependencies (for dependency injection)
and for each <em>built-in cloud service</em>, it sends a message to the ZetaPush cloud
to create the service <span class="sequence-step">13</span> <span class="sequence-step">14</span>. Once all <em>built-in cloud services</em> are ready, the worker
instantiates all <em>built-in cloud services</em> and <em>custom cloud services</em> needed for
the test (indicated by <code>given().worker().dependencies()</code>) <span class="sequence-step">15</span>
<span class="sequence-step">16</span> <span class="sequence-step">17</span> <span class="sequence-step">18</span>.
Once everything is instantiated, your <em>custom cloud service</em> is ready to be called.
At the end of the <code>apply</code> function of the testing utilities, the information
about the execution context (credentials, dependencies, instances, &#8230;&#8203;) are stored
in <code>this</code> <span class="sequence-step">19</span>. <code>this</code> refers to the current test execution context in jasmine.</p>
</div>
<div class="paragraph">
<p>Now, everything is ready to really start the test. The <code>it</code> function provided by jasmine is
executed. This function calls <code>runInWorker(this, callback)</code> <span class="sequence-step">20</span>. As said above, <code>this</code> refers
to the current test execution context in jasmine. So everything stored in <code>this</code> in
<code>beforeEach</code> is available in <code>this</code> of <code>it</code>. <code>runInWorker</code> starts the worker using
the code written in the <code>callback</code> as source code for a "virtual" <em>cloud function</em> <span class="sequence-step">21</span>.
The "virtual" <em>cloud function</em> (<code>callback</code>) receives parameters. Each parameter
is the instance of a needed dependency (defined with <code>given().worker().dependencies()</code>
in the <strong>same order</strong>).
As it is like a real <em>cloud function</em>, the code is executed by the worker <span class="sequence-step">22</span>.
Then each line of code is executed. In our test, we first empty the <code>Stack</code> by calling
<code>purge()</code> <span class="sequence-step">23</span> <span class="sequence-step">26</span>. This sends a message to
the ZetaPush cloud <span class="sequence-step">24</span> <span class="sequence-step">25</span>.
The test then calls <code>helloWorldService.saySomething('hello', 5)</code> <em>cloud function</em>
<span class="sequence-step">27</span> <span class="sequence-step">28</span>.
<code>helloWorldService.getStoredMessages()</code> <em>cloud function</em> is called to retrieve all
stored messages <span class="sequence-step">29</span> <span class="sequence-step">30</span>.
At the end of the test we use <code>expect</code> function provided by jasmine in order to ensure
that results correspond to what we expect.</p>
</div>
<div class="paragraph">
<p>The test is now finished (either successfully or with failure). <code>afterEach</code> is called by jasmine
which calls <code>autoclean(this)</code> utility <span class="sequence-step">31</span>. As the worker has been started locally and
it has instantiated dependencies, we need to clean everything. <code>autoclean</code> will
use information stored in <code>this</code> to know exactly what it has to do. In our case,
we just need to stop the worker properly <span class="sequence-step">32</span>
<span class="sequence-step">33</span> <span class="sequence-step">34</span> <span class="sequence-step">35</span>.</p>
</div>
<div class="paragraph">
<p>Notice that local tests allow to test part of your application.
You don&#8217;t need to develop all your <em>custom cloud services</em> before testing them partially.
This is a great advantage for developing fast because you can define a closed and
well defined context that doesn&#8217;t depend directly on the code you write in your
<em>custom cloud services</em>. Maintainability is easier because even if your
code change, the context dedicated to the test may be the same.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Advanced integration testing</div>
<div class="paragraph">
<p>For more advanced usage, you can find information about
<a href="./reference.html#testing_utilities">testing utilities</a> and
<a href="./reference.html#integration_testing">integration testing</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Trial account</div>
<div class="paragraph">
<p>If you have a free trial account, you have only one environment shared between
local development, published application and tests.</p>
</div>
<div class="paragraph">
<p>The execution of the tests may impact the published application because there
are two workers started in the same time on the same environment.
So the load-balancer may send request either to the worker running on ZetaPush cloud
or to the local worker started in tests. You could also have false positives
in your tests due to the load-balancing (because worker running in the ZetaPush
cloud could answer in place of the runner in tests).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Remote integration testing</div>
<div class="paragraph">
<p>Running tests locally may differ a little compared to running the tests in the cloud.
Indeed, the running context is different especially when working with HTTP because
URLs, load-balancing and network infrastructure are different.</p>
</div>
<div class="paragraph">
<p>ZetaPush also provides tools to run your <a href="./reference.html#tests_in_cloud">tests with a worker running in the ZetaPush cloud</a>.
This is totally transparent for you.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_local_end_to_end_test"><a class="anchor" href="#_local_end_to_end_test"></a>Local end-to-end test</h6>
<div class="paragraph">
<p>Here the tests are run exclusively in a worker context. ZetaPush also provides
a way to write end-to-end (often named e2e) tests. This means that a client
really make requests to the <em>cloud service</em> instead of calling directly a method.</p>
</div>
<div class="paragraph">
<p>You can copy the file <code>.spec/hellp-world-custom-cloud-service/say-something.it.spec.js</code>
into the new file <code>.spec/hellp-world-custom-cloud-service/say-something.e2e.spec.js</code>
and transform code to an e2e test:</p>
</div>
<div class="listingblock highlight-lines:1,9-14,25-27">
<div class="title">spec/hellp-world-custom-cloud-service/say-something.e2e.spec.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td>
  <td class="code"><pre>const { given, frontAction, autoclean } = require(<span class="string"><span class="delimiter">'</span><span class="content">@zetapush/testing</span><span class="delimiter">'</span></span>);

describe(<span class="string"><span class="delimiter">'</span><span class="content">HelloWorldAsCustomCloudService.</span><span class="delimiter">'</span></span>, () =&gt; {
  beforeEach(async () =&gt; {
    await given()
      <span class="comment">/**/</span> .credentials()
      <span class="comment">/*   */</span> .fromZetarc()
      <span class="comment">/*   */</span> .and()
      <span class="comment">/**/</span> .project()                                               <i class="conum" data-value="1"></i><b>(1)</b>
      <span class="comment">/*   */</span> .currentProject()                                     <i class="conum" data-value="2"></i><b>(2)</b>
      <span class="comment">/*     */</span> .and()
      <span class="comment">/*   */</span> .and()
      <span class="comment">/**/</span> .worker()                                                <i class="conum" data-value="3"></i><b>(3)</b>
      <span class="comment">/*   */</span> .up()                                                 <i class="conum" data-value="4"></i><b>(4)</b>
      <span class="comment">/*   */</span> .and()
      .apply(<span class="local-variable">this</span>);
  }, <span class="integer">5</span> * <span class="integer">60</span> * <span class="integer">1000</span>);

  <span class="comment">/**
   * Nominal case with a message repeated 5 times
   */</span>
  describe(<span class="string"><span class="delimiter">&quot;</span><span class="content">saySomething('hello', 5)</span><span class="delimiter">&quot;</span></span>, () =&gt; {
    it(<span class="string"><span class="delimiter">'</span><span class="content">stores the message, the number of repetitions and the generated message</span><span class="delimiter">'</span></span>,
      async () =&gt; {
        await frontAction(<span class="local-variable">this</span>)                                     <i class="conum" data-value="5"></i><b>(5)</b>
          .name(<span class="string"><span class="delimiter">'</span><span class="content">call saySomething</span><span class="delimiter">'</span></span>)                                <i class="conum" data-value="6"></i><b>(6)</b>
          .execute(async (api) =&gt; {                                 <i class="conum" data-value="7"></i><b>(7)</b>
            <span class="comment">// call the method to test</span>
            await api.saySomething(<span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>, <span class="integer">5</span>);                     <i class="conum" data-value="8"></i><b>(8)</b>

            <span class="comment">// check that everything works fine</span>
            const storedMessages = await api.getStoredMessages();   <i class="conum" data-value="9"></i><b>(9)</b>
            expect(storedMessages.length).toBe(<span class="integer">1</span>);
            expect(storedMessages[<span class="integer">0</span>]).toEqual({
              <span class="key">message</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="delimiter">'</span></span>,
              <span class="key">times</span>: <span class="integer">5</span>,
              <span class="key">fullMessage</span>: <span class="string"><span class="delimiter">'</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="content">\n</span><span class="content">hello</span><span class="delimiter">'</span></span>
            });
          });
      },
      <span class="integer">5</span> * <span class="integer">60</span> * <span class="integer">1000</span>
    );
  });

  afterEach(async () =&gt; {
    await autoclean(<span class="local-variable">this</span>);
  });
});</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instead of defining a module that contains a part of your application to test (using <code>worker().testModule()</code>),
here you need the full application. That&#8217;s the purpose of <code>project()</code> fluent API.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Indicate that the source project is your current project.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>There is a <code>worker</code> section too&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>But this time, we just ask for testing utility to start the worker with
your <em>custom cloud service</em> defined in <code>index.ts</code> and wait until
the worker is really started before executing the test.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Instead of running in the context of the worker, now we run code directly from
a client point of vue. Like <code>runInWorker</code>, <code>frontAction</code> needs the test context (<code>this</code>)
to retrieve information initialized by the <code>given()</code> utility.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Give a name to the action (useful for logs)</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Execute code in front context. The function that is executed receives the parameter <code>api</code>.
Under the hood, the test utility creates a client (<code>const client = new ZetaPushClient.WeakClient()</code>) and then
creates the proxy to the API (<code>api = client.createProxyTaskService()</code>). So <code>api</code> parameter is the object you can use
to directly call your <em>cloud functions</em> from a client.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Call the <em>cloud function</em> we want to test.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>Retrieve all stored messages and make assertions on the result.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As always, you run the tests by running jasmine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ node -r ts-node/register node_modules/jasmine/bin/jasmine</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the test may fail and it is normal because the <code>Stack</code> may already contain data.
As said before here we are in the context of a client so we don&#8217;t have access to <code>Stack</code>
service to empty it before running the test.
To empty the <code>Stack</code> you have to either add a <em>cloud function</em> that can empty the stack or use
<a href="./reference.html#test-snapshot">ZetaPush snapshots</a> to restore your application
to a particular state before running your tests.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Snapshots</div>
<div class="paragraph">
<p>The snapshot feature is already available in ZetaPush but it is not currently
exposed for use directly in tests.</p>
</div>
<div class="paragraph">
<p>This feature will be available soon.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following sequence diagram explains how it works:</p>
</div>
<div class="imageblock center">
<div class="content">
<img src="local-e2e-testing.png" alt="local e2e testing" width="1425" height="2446">
</div>
<div class="title">Figure 8. How it works ?</div>
</div>
<div class="paragraph">
<p>Context initialization done by <code>given()</code> <span class="sequence-step">1</span> utility has exactly the same behavior as
integration testing. The only difference is that instead of creating a "virtual"
module to define a "virtual" <em>custom cloud service</em>, <code>given().project().currentProject()</code>
<span class="sequence-step">2</span> <span class="sequence-step">3</span>
indicates that you want directly the code of your application to be tested.
<code>given().worker().up()</code> <span class="sequence-step">4</span> <span class="sequence-step">5</span> indicates that you need the worker fully started
before running the test.</p>
</div>
<div class="paragraph">
<p><code>it()</code> code now uses <code>front(this)</code> <span class="sequence-step">20</span> that is a fluent API to
create a client based on what you need. <code>front(this).name()</code> <span class="sequence-step">22</span> is used to
add an information message in logs during test execution. It is useful if you
want to separate several calls to simulate several end-users for example.
Until now, no client is created.
It is <code>front(this).execute(callback)</code> <span class="sequence-step">24</span> that uses information
defined before (name and current test context in this case) in order to create
a client instance <span class="sequence-step">26</span>. The testing utilities connect the client
to the ZetaPush cloud <span class="sequence-step">27</span> <span class="sequence-step">28</span> using information provided in <code>given().credentials()</code>.
In addition to a client, this function also creates the client
API (<code>api</code>) <span class="sequence-step">29</span> by calling <code>client.createProxyTaskService</code> under the hood. As a
reminder, <code>api</code> created with <code>client.createProxyTaskService</code> provides directly
same methods to the client that the <em>cloud functions</em> defined in the <em>custom cloud service</em>
without writing a single line of code (no need to manually define a function <code>saySomething</code>
on the client side). Once the client is ready, the code defined inside the <code>callback</code>
is executed <span class="sequence-step">30</span> <span class="sequence-step">31</span>.
In the test, the <em>cloud function</em> <code>saySomething</code> is called through <code>api</code> <span class="sequence-step">32</span>.
Contrary to integration testing which calls <em>cloud functions</em> directly, calls to
<code>api</code> sends messages through network from the client to the ZetaPush cloud <span class="sequence-step">33</span>.
ZetaPush cloud routes the message to the worker started by testing utilities <span class="sequence-step">34</span>.
The worker receives the request and calls the <em>cloud function</em> <span class="sequence-step">35</span>.
The result is sent by the worker to the ZetaPush cloud <span class="sequence-step">37</span> which routes the result
to the client <span class="sequence-step">38</span>. The client receives the result and can use it <span class="sequence-step">39</span>.
The same process applies when calling <code>getStoredMessages()</code> <span class="sequence-step">40</span> <span class="sequence-step">41</span>
<span class="sequence-step">42</span> <span class="sequence-step">43</span> <span class="sequence-step">44</span> <span class="sequence-step">45</span>
<span class="sequence-step">46</span> <span class="sequence-step">47</span>.</p>
</div>
<div class="paragraph">
<p>The <code>autoclean(this)</code> works exactly the same as in integration tests.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Client authentication</div>
<div class="paragraph">
<p>In the example, the <em>custom cloud service</em> exposes <em>cloud functions</em> that
don&#8217;t need authentication and that don&#8217;t have any security restrictions.
So implicitly we can use an anonymous connection using <code>WeakClient</code>.</p>
</div>
<div class="paragraph">
<p>But in a real application you may need to authenticate as a real user in your
tests. Hopefully, you can <a href="./reference.html#testing_utilities">provide end-user credentials</a>
when using <code>front(this)</code>. In this case, a <code>Simple</code> client instance is automatically
used.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Advanced e2e testing</div>
<div class="paragraph">
<p>For more advanced usage, you can find information about
<a href="./reference.html#testing_utilities">testing utilities</a> and
<a href="./reference.html#e2e_testing">integration testing</a></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_publish_your_application"><a class="anchor" href="#_deploy_publish_your_application"></a>Deploy/publish your application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have developed your application and tested it, you may want to deploy it on the ZetaPush cloud.
Deploying means that your code is sent to the ZetaPush cloud and your application
runs directly on it. The ZetaPush cloud
hosts your application and makes it available on the Internet for your end-users.</p>
</div>
<div class="paragraph">
<p>Usually, you deploy/publish your application when you are ready to promote it in production.</p>
</div>
<div class="paragraph">
<p>Unlike in standard development of an application, with ZetaPush you don&#8217;t need to bother to
buy, install, configure and manage the machines anymore.
Everything is already provided by the ZetaPush cloud. Moreover, the ZetaPush cloud
guarantees that your application is always available. You don&#8217;t need
to worry about how to handle technical complexities like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://en.wikipedia.org/wiki/Redundancy_(engineering)" target="_blank" rel="noopener">Redundancy</a> (duplication of your application to increase reliability)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Load_balancing_(computing)" target="_blank" rel="noopener">Load-balancing</a> (automatic distribution of tasks accross several workers)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/High_availability" target="_blank" rel="noopener">High availability</a> (ensure that your application is always up)</p>
</li>
<li>
<p><a href="https://en.wikipedia.org/wiki/Scalability" target="_blank" rel="noopener">Scalability</a> (increase the number of worker instances when the application usage increases)</p>
</li>
<li>
<p>Supervision (monitor machines and your application to alert you in case of a performance, machine or availability issue)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>ZetaPush already monitors the machines and your applications. However, the supervision is currently
not direclty available to you.</p>
</div>
<div class="paragraph">
<p>Soon the <a href="https://console-celtia.zetapush.com" target="_blank" rel="noopener">ZetaPush web console</a> will display monitoring
information.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>With a free trial account there is no scalability, high availability and load-balancing
because the trial plan only allows one worker per application.</p>
</div>
<div class="paragraph">
<p>You can <a href="https://www.zetapush.com/contact" target="_blank" rel="noopener">contact us</a> if you want to test those features.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_what_will_be_deployed"><a class="anchor" href="#_what_will_be_deployed"></a>What will be deployed ?</h3>
<div class="paragraph">
<p>When you <em>deploy</em> your application on the ZetaPush cloud,
actually your application is split in two parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The worker that contains your <em>custom cloud services</em></p>
</li>
<li>
<p>The static files for the front end</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_worker"><a class="anchor" href="#_worker"></a>Worker</h4>
<div class="paragraph">
<p>When you deploy the worker (<em>custom cloud services</em>) of your application, we take care of the hosting of your code.
In addition we manage the redundancy, the load-balancing,
the high availability and the automatic scability of your <em>custom cloud services</em>.</p>
</div>
<div class="paragraph">
<p>A worker may also provide HTTP endpoints in addition to bidirectionnal connection provided as-is by ZetaPush.
If so, once published on the ZetaPush cloud, the HTTP url is displayed in your terminal.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>URLs to access your worker in HTTP(s) are also available in the <a href="https://console-celtia.zetapush.com" target="_blank" rel="noopener">ZetaPush web console</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_front_end"><a class="anchor" href="#_front_end"></a>Front end</h4>
<div class="paragraph">
<p>For the front end part, the ZetaPush cloud hosts your application.
ZetaPush also manages redundancy of the static files in order to ensure
the high availability of you front end application.</p>
</div>
<div class="paragraph">
<p>The URL to access to your application is displayed in your terminal.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>URLs to access your front end are also available in the <a href="https://console-celtia.zetapush.com" target="_blank" rel="noopener">ZetaPush web console</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_environments"><a class="anchor" href="#_environments"></a>Environments</h3>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>This section will describe how to deploy your application
in the ZetaPush cloud for a particular environment.</p>
</div>
<div class="paragraph">
<p>It will also give you information about configuration properties
and property override per environment.</p>
</div>
<div class="paragraph">
<p>see <a href="https://github.com/zetapush/documentation/issues/54" class="bare">https://github.com/zetapush/documentation/issues/54</a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_application_on_the_zetapush_cloud"><a class="anchor" href="#_deploy_application_on_the_zetapush_cloud"></a>Deploy application on the ZetaPush Cloud</h3>
<div class="paragraph">
<p>The deployment is very easy, to do this you only need to launch this command in your application directory:</p>
</div>
<div class="listingblock">
<div class="title">Deploy the application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run deploy</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Npm script alias</div>
<div class="paragraph">
<p><code>npm run deploy</code> is a script alias defined in the <code>package.json</code> file.
The command that is executed under the hood is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ zeta push</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The command will read the <code>.zetarc</code> file. If there is no <em>appName</em>, <em>developerLogin</em> and <em>developerPassword</em> properties or if the ZetaPush account is not validated, you will not be able to push your application.</p>
</div>
<div class="paragraph">
<p>When you deploy your application (Front + Worker), the CLI displays the URLs to use it.
Run the command and you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">&gt; zeta push

[INFO] Using application defined in configuration: v79ivn00l  ‌
[INFO] Bundle your application components  ‌
[INFO] ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ Upload code                                       <i class="conum" data-value="1"></i><b>(1)</b>
[INFO] ▇▇▇▇▇▇▇▇▇▇░░░░░░░░░░ Prepare environment
[INFO] ░░░░░░░░░░░░░░░░░░░░ Publish web application
[INFO] ░░░░░░░░░░░░░░░░░░░░ Preparing custom cloud services for deployment
[INFO] ░░░░░░░░░░░░░░░░░░░░ Publish custom cloud service on worker instance</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>CLI</em> displays progress bars to indicate all deployment tasks and
which tasks are currently being executed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once the deployment has succeeded, you should see the URLs where your worker and
front are available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">&gt; zeta push

[INFO] Using application defined in configuration: v79ivn00l  ‌
[INFO] Bundle your application components  ‌
[INFO] ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ Upload code
[INFO] ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ Prepare environment
[INFO] ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ Publish web application
[INFO] ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ Preparing custom cloud services for deployment
[INFO] ▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇▇ Publish custom cloud service on worker instance
[INFO] Web application front is available at http://front-v79ivn00l.celtia.zetapush.app:80/  ‌      <i class="conum" data-value="1"></i><b>(1)</b>
[INFO] Worker application queue_0 is available at http://queuea0-v79ivn00l.test.zetapush.app  ‌     <i class="conum" data-value="2"></i><b>(2)</b>
[INFO] Worker applications works only if you listen process.env.HTTP_PORT  ‌</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The URL for your front available on the Internet</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The URL for the HTTP endpoint of your worker (if you have one)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can click (<span class="keyseq"><kbd>Ctrl</kbd>+<kbd>click</kbd></span>) in the terminal on the front URL (or open a web browser
and enter the front URL).
You can see that your application is deployed.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Redeploy</div>
<div class="paragraph">
<p>Obviously, you can publish your application again anytime you want to update it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Shared <em>built-in cloud services</em></div>
<div class="paragraph">
<p>You can notice that the data that was stored when you were running your application
locally is also available once the application is deployed.</p>
</div>
<div class="paragraph">
<p>This is normal because this is the same application.
So the application uses the same <em>built-in cloud services</em>.</p>
</div>
<div class="paragraph">
<p>If you want to separate data between your local development and the deployed application,
you need to define several <a href="./reference.html#manage_environments">environments</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Partial deployment</div>
<div class="paragraph">
<p>It is possible to <a href="./reference.html#partial_deployment">deploy only one part of your application</a> (only the front or only the worker).</p>
</div>
<div class="paragraph">
<p>This can be useful for example when there is a bug that is fixed by exclusively patching the front part.
So you just want to deploy your front but not deploy the same worker code again (and vice versa).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">How to have initialization code</div>
<div class="paragraph">
<p>A <em>custom cloud service</em> may have initialization code to configure and prepare your application.</p>
</div>
<div class="paragraph">
<p>As said before, once published in the ZetaPush cloud, ZetaPush handles scalability and
high availability. So several worker instances will run in the same time and ZetaPush will
load-balance traffic between worker instances. In order to ensure that <strong>only one worker</strong> executes
some initialization code, ZetaPush provides <a href="./reference.html#onapplicationbootstrap"><code>onApplicationBootstrap</code> special method</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Snapshot and rollback</div>
<div class="paragraph">
<p>In future version, every deployment will trigger a <a href="./reference.html#snapshots">snapshot</a> to store
the whole application state and data. The aim is to provide you a tool to
quickly restore the previous version.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_user_management_in_your_application"><a class="anchor" href="#_user_management_in_your_application"></a>User management in your application</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_presentation"><a class="anchor" href="#_presentation"></a>Presentation</h3>
<div class="paragraph">
<p>In a software application, we (almost) always need to manage users. The <strong>Standard User Workflow</strong> helps you to do this, in the most common use case (for
business to customer application on the Internet). This cloud service helps you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Signup a user</p>
</li>
<li>
<p>Log in a user</p>
</li>
<li>
<p>Log out a user</p>
</li>
<li>
<p>Manage a forgotten password</p>
</li>
<li>
<p>Manage permissions of users</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Authentication</div>
<div class="paragraph">
<p>At this moment, the connection and the disconnection of a user is done through the ZetaPush SDK (We will see below how to do this).</p>
</div>
<div class="paragraph">
<p>In the future, the connection and disconnection will be handled by <code>StandardUserWorkflow</code> in order to provide you
a clearer API.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For us, the most common use case is when a user can create its own account using a login and a password and needs to confirm his account via a link in an email.
Once its account is validated, he can login and use the application.</p>
</div>
<div class="paragraph">
<p><strong>Sign up: </strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images//schemas/standarduserworkflow-signup.png" alt="standarduserworkflow signup">
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The user creates his account using a login, a password and an email. When the user submits the form, the account is created on the ZetaPush platform. In order to ensure that the user is not a bot, the account has to be confirmed before the user is authorized to login.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>An email is sent to the user in order to confirm its account. The email contains the confirmation link. He needs to confirm his account before connection.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When the user clicks on the link in the email, he is authorized to login.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Log in: </strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images//schemas/standarduserworkflow-login.png" alt="standarduserworkflow login">
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>When the user account is confirmed, he can log in the application using the his login and his password.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Account not confirmed</div>
<div class="paragraph">
<p>If the user tries to log into the application before he confirmed his account, an error will be returned to explain that the account needs to be confirmed via the link in the confirmation email.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_quick_start"><a class="anchor" href="#_quick_start"></a>Quick start</h3>
<div class="paragraph">
<p>In this part we will explain how to use the <strong>Standard User Workflow</strong> in the default behavior, i.e. using the default implementations of each parts of the workflow.</p>
</div>
<div class="paragraph">
<p>To use the Standard User Workflow, you just need 4 steps :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a ZetaPush application as usual</p>
</li>
<li>
<p>Import and use the Standard User Workflow in your worker</p>
</li>
<li>
<p>Configure some properties</p>
</li>
<li>
<p>Develop your front by calling the Standard User Workflow API</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_create_a_zetapush_application_as_usual"><a class="anchor" href="#_create_a_zetapush_application_as_usual"></a>Create a ZetaPush application as usual</h4>
<div class="paragraph">
<p>In this Quickstart, we begin with a generated application using the CLI. So you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm init @zetapush app-with-user-management</code></pre>
</div>
</div>
<div class="paragraph">
<p>We import the library <code>@zetapush/user-management</code> that provides the Standard User Workflow using NPM:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm install --save @zetapush/user-management</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_import_and_use_the_standard_user_workflow_in_your_worker"><a class="anchor" href="#_import_and_use_the_standard_user_workflow_in_your_worker"></a>Import and use the Standard User Workflow in your worker</h4>
<div class="paragraph">
<p>Change the code of the <em>custom cloud service</em> defined in <code>worker/index.ts</code> file:</p>
</div>
<div class="listingblock">
<div class="title">worker/index.ts</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td>
  <td class="code"><pre><span class="reserved">import</span> {
  StandardUserWorkflow,                       <i class="conum" data-value="1"></i><b>(1)</b>
  StandardUserManagementModule,               <i class="conum" data-value="2"></i><b>(2)</b>
  ConfirmationUrlHttpHandler                  <i class="conum" data-value="3"></i><b>(3)</b>
} from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/user-management</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> { Module } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/core</span><span class="delimiter">'</span></span>;      <i class="conum" data-value="4"></i><b>(4)</b>

<span class="error">@</span>Module({                                     <i class="conum" data-value="5"></i><b>(5)</b>
  <span class="key">imports</span>: [StandardUserManagementModule],    <i class="conum" data-value="6"></i><b>(6)</b>
  <span class="key">expose</span>: {
    <span class="key">user</span>: StandardUserWorkflow,               <i class="conum" data-value="7"></i><b>(7)</b>
    <span class="key">http</span>: ConfirmationUrlHttpHandler          <i class="conum" data-value="8"></i><b>(8)</b>
  }
})
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> Api {}                   <i class="conum" data-value="9"></i><b>(9)</b></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>StandardUserWorkflow</code> is the <em>cloud service</em> we want to use. It is this class
that provides the <em>cloud functions</em> to handle user registration, password reset, login and logout.
Here we just import the TypeScript class.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>StandardUserWorkflow</code> <em>cloud service</em> is encapsulated in the <code>StandardUserManagementModule</code> module.
We also need to import TypeScript class for later use.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>StandardUserManagementModule</code> module also provides <code>ConfirmationUrlHttpHandler</code> in
order to provide an HTTP endpoint to handle the confirmation link that will be clicked in the email.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Import the <code>Module</code> annotation for TypeScript.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>@Module</code> annotation is used here to indicate to the worker
which <em>cloud services</em> you want to use and how you want to use it
in your <em>custom cloud service</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We indicate to the worker that we import the module <code>StandardUserManagementModule</code>.
It means that everything provided by the module is now available to
your <em>custom cloud service</em>.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>We indicate that we directly expose <code>StandardUserWorkflow</code> <em>cloud service</em>. It means that
<em>cloud functions</em> defined by <code>StandardUserWorkflow</code> are directly callable from a client.</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>We indicate that we also expose <code>ConfirmationUrlHttpHandler</code>. It means that
the HTTP endpoint is directly callable by opening the confirmation URL in a web browser.</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>As usual we export the entry point of your <em>custom cloud services</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>That all for the worker code !</strong></p>
</div>
<div class="paragraph">
<p>The code above basically declares your <em>custom cloud service</em> as a new <a href="./reference.html#modules">ZetaPush module</a>.
In this case, we don&#8217;t need to create a module but the <code>@Module</code> is needed to import another module.
Importing a module (using <code>imports</code> option) only indicates that you want to use a module somewhere in your <em>custom cloud service</em>.
It doesn&#8217;t automatically expose anything. This is deliberate because you may want to not directly
expose the <code>StandardUserWorkflow</code> <em>cloud functions</em> to the client. You could then define a <em>custom cloud service</em>
that is exposed and delegate user management to the <code>StandardUserWorkflow</code> <em>cloud functions</em>.</p>
</div>
<div class="paragraph">
<p>The quickest way to benefit from user management is to directly expose <code>StandardUserWorflow</code> to the client.
It means that the <em>cloud functions</em> provided by <code>StandardUserWorkflow</code> are directly callable from a client.
So you don&#8217;t need to code anything in your <em>custom cloud service</em> and you can focus on the front side.
To expose the <code>StandardUserWorkflow</code> you simply need to add the <code>expose</code> option on the <code>@Module</code>
annotation. In addition to exposing <code>StandardUserWorkflow</code> to a client that uses the bidirectional
connection to interact with <code>StandardUserWorflow</code> <em>cloud functions</em>, we also expose <code>ConfirmationUrlHttpHandler</code>
in order to start a web server that listens to HTTP requests done on the account confirmation URL.
The aim is to directly provide you the verification of the confirmation of the account when the user clicks
on the confirmation link in the email. You don&#8217;t need to bother to check if the confirmation token
is valid and to handle token expiration.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Modules</div>
<div class="paragraph">
<p>ZetaPush provides <a href="./reference.html#modules">modules</a> to encapsulate
several <em>cloud services</em> and to be able to reuse them.</p>
</div>
<div class="paragraph">
<p>As seen before, when you have a really simple <em>custom cloud service</em>,
you just expose a class (without <code>@Module</code> annotation). In this case,
ZetaPush worker defines an implicit module that imports nothing and
exposes your class.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Expose several <em>cloud services</em></div>
<div class="paragraph">
<p>As we expose several classes, we define a map:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">expose: {
  <span class="key">user</span>: StandardUserWorflow,
  <span class="key">http</span>: ConfirmationUrlHttpHandler
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The keys of the map correspond to <a href="./reference.html#namespaces">namespaces</a>.
ZetaPush provides namespaces in order to be able to expose several
<em>cloud services</em> each isolated by a name. The aim is to be able to have
for example two <em>cloud functions</em> named <code>hello</code> in two different
<em>cloud services</em> that are exposed. So on the client side, the name
is used to specify which <em>cloud service</em> to use when we call
the <em>cloud function</em> <code>hello</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Listen to HTTP requests</div>
<div class="paragraph">
<p>ZetaPush uses a bidirectional connection to interact between client and <em>cloud services</em> (and vice versa).
But in some cases, the bidirectional connection can&#8217;t be used as for the confirmation link.
Indeed the confirmation link is just an URL that opens a web browser when it is clicked by the
end-user. The web browser performs an HTTP <code>GET</code> request on that URL.
That&#8217;s why ZetaPush also handles HTTP.</p>
</div>
<div class="paragraph">
<p>You can even provide your own HTTP routes to listen to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Either by registering a route in the <a href="./reference.html#internal_http_server">ZetaPush web server</a></p>
</li>
<li>
<p>Or by using your <a href="./reference.html#custom_http_server">own HTTP server</a> (you can even use any library
or framework you want like <a href="http://expressjs.com/" target="_blank" rel="noopener">express</a> for example)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this example, <code>ConfirmationUrlHttpHandler</code> registers a route for the confirmation URL in the ZetaPush web server.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_configure_some_properties"><a class="anchor" href="#_configure_some_properties"></a>Configure some properties</h4>
<div class="paragraph">
<p>The code is ready but in order to adapt the workflow to your needs, some configuration properties are required.
To configure those properties, you need to create a file named <code>application.json</code> at the root of your application:</p>
</div>
<div class="listingblock">
<div class="title">application.json</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td>
  <td class="code"><pre>{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">no-reply@your-application-name.com</span><span class="delimiter">&quot;</span></span>    <i class="conum" data-value="1"></i><b>(1)</b>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">smtp</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">host</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">smtp.mailtrap.io</span><span class="delimiter">&quot;</span></span>,                     <i class="conum" data-value="2"></i><b>(2)</b>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">port</span><span class="delimiter">&quot;</span></span>: <span class="integer">2525</span>,                                   <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">username</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,                                 <i class="conum" data-value="4"></i><b>(4)</b>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>,                                 <i class="conum" data-value="5"></i><b>(5)</b>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">ssl</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>,                                   <i class="conum" data-value="6"></i><b>(6)</b>
    <span class="key"><span class="delimiter">&quot;</span><span class="content">starttls</span><span class="delimiter">&quot;</span></span>: <span class="value">false</span>                               <i class="conum" data-value="7"></i><b>(7)</b>
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>As an email is sent to the end user for confirming its account,
you need to configure the email sender. The email sender address
may not be totally what you want and may depend on your email
provider. For the example, we use a testing service that allows
any email address as email sender (see tip about Mailtrap below).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the domain or the host for the SMTP server</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Configure the port of the SMTP server</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure username used to authenticate on the SMTP server</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Configure password used to authenticate on the SMTP server</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Set to true if your SMTP server requires SSL</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Set to true if your SMTP server requires TLS</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this example, we provide only the minimal required configuration. We only need to configure email
sending. All other configuration properties are optional.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Test inscription and confirmation using Mailtrap</div>
<div class="paragraph">
<p>For the example, we show the usage of <a href="https://mailtrap.io/" target="_blank" rel="noopener">mailtrap</a>. This is an online
service that provides a SMTP server. There is a free plan to test email sending.</p>
</div>
<div class="paragraph">
<p>If you want to test, just signup to mailtrap and fill <code>username</code> and <code>password</code> in <code>application.json</code>.</p>
</div>
<div class="paragraph">
<p>If you already have your own SMTP server, you can directly enter your SMTP configuration in <code>application.json</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Configuration properties</div>
<div class="paragraph">
<p>The <code>application.json</code> file is not pure JSON. In fact, it accepts comments. This can
be useful to document some properties.</p>
</div>
<div class="paragraph">
<p>You can learn more about <a href="./reference.html#configuration_properties"><code>application.json</code> and how to use configuration properties</a>.</p>
</div>
<div class="paragraph">
<p>You can also learn <a href="./reference.html#configuration-of-standard-user-workflow">how to deeply configure the Standard User Workflow</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_develop_your_front_by_calling_the_standard_user_workflow_api"><a class="anchor" href="#_develop_your_front_by_calling_the_standard_user_workflow_api"></a>Develop your front by calling the Standard User Workflow API</h4>
<div class="paragraph">
<p>Finally, we just need to call the <em>cloud function</em> to create a user account, log in and log out from the client part.</p>
</div>
<div class="paragraph tab-container">
<p>Front code</p>
</div>
<div class="paragraph tab">
<p>index.js</p>
</div>
<div class="paragraph">
<p>You can replace the <code>front/index.js</code> file by the following content :</p>
</div>
<div class="listingblock">
<div class="title">front/index.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td>
  <td class="code"><pre><span class="comment">// Create the ZetaPush API</span>
const client = <span class="keyword">new</span> ZetaPushClient.SmartClient();
const userApi = client.createProxyTaskService({                               <i class="conum" data-value="1"></i><b>(1)</b>
  <span class="key">namespace</span>: <span class="string"><span class="delimiter">'</span><span class="content">user</span><span class="delimiter">'</span></span>
});

async <span class="keyword">function</span> <span class="function">signUpUser</span>(form) {                                             <i class="conum" data-value="2"></i><b>(2)</b>
  const login = form[<span class="integer">0</span>].value;
  const password = form[<span class="integer">1</span>].value;
  const email = form[<span class="integer">2</span>].value;
  <span class="comment">// First connection as anonymous user to allow us to create a user</span>
  await client.connect();

  <span class="comment">// Creation of the user account</span>
  <span class="keyword">try</span> {
    await userApi.signup({
      <span class="key">credentials</span>: {
        login,
        password
      },
      <span class="key">profile</span>: {
        email
      }
    });
    console.log(<span class="string"><span class="delimiter">'</span><span class="content">User account created</span><span class="delimiter">'</span></span>);
  } <span class="keyword">catch</span> (err) {
    console.error(<span class="string"><span class="delimiter">'</span><span class="content">Failed to create user account : </span><span class="delimiter">'</span></span>, err);
  }
}

<span class="comment">/**
 * Connection of a user
 */</span>
async <span class="keyword">function</span> <span class="function">loginUser</span>(form) {                                              <i class="conum" data-value="3"></i><b>(3)</b>
  const login = form[<span class="integer">0</span>].value;
  const password = form[<span class="integer">1</span>].value;

  await client.setCredentials({ login, password });
  client
    .connect()
    .then(() =&gt; {
      console.log(<span class="string"><span class="delimiter">'</span><span class="content">User connected</span><span class="delimiter">'</span></span>);
    })
    .<span class="keyword">catch</span>(err =&gt; {
      console.error(<span class="string"><span class="delimiter">'</span><span class="content">Failed to connect user : </span><span class="delimiter">'</span></span>, err);
    });
}

<span class="comment">/**
 * Disconnection of a user
 */</span>
async <span class="keyword">function</span> <span class="function">logoutUser</span>() {                                                 <i class="conum" data-value="4"></i><b>(4)</b>
  await client.disconnect();
  console.log(<span class="string"><span class="delimiter">'</span><span class="content">User disconnected</span><span class="delimiter">'</span></span>);
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We created a ZetaPush client and his API to call our cloud functions.
We use the namespace <code>user</code> to call the <code>StandardUserWorkflow</code> <em>cloud functions</em>.
Remember the <code>expose</code> option on <code>@Module</code> configuration and the <code>user</code> key in the map.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Function to create an account of the ZetaPush platform for this application.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Function to connect a user.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Function to disconnect a user.</td>
</tr>
</table>
</div>
<div class="paragraph tab">
<p>index.html</p>
</div>
<div class="paragraph">
<p>Here is a very basic HTML page with two forms (one to create an account, the other to login):</p>
</div>
<div class="listingblock">
<div class="title">front/index.html</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="html"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td>
  <td class="code"><pre><span class="doctype">&lt;!DOCTYPE html&gt;</span>
<span class="tag">&lt;html</span> <span class="attribute-name">lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

<span class="tag">&lt;head&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">charset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UTF-8</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;meta</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">viewport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">content</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">width=device-width, initial-scale=1.0</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;title&gt;</span>Standard User Workflow<span class="tag">&lt;/title&gt;</span>
<span class="tag">&lt;/head&gt;</span>

<span class="tag">&lt;body&gt;</span>
  <span class="tag">&lt;h1&gt;</span>Signup<span class="tag">&lt;/h1&gt;</span>
  <span class="tag">&lt;form</span> <span class="attribute-name">onsubmit</span>=<span class="string"><span class="delimiter">&quot;</span>event.preventDefault(); signUpUser(<span class="local-variable">this</span>);<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>   <i class="conum" data-value="1"></i><b>(1)</b>
    Login: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    Password: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    Email: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Sign up<span class="tag">&lt;/button&gt;</span>
  <span class="tag">&lt;/form&gt;</span>

  <span class="tag">&lt;h1&gt;</span>Login<span class="tag">&lt;/h1&gt;</span>
  <span class="tag">&lt;form</span> <span class="attribute-name">onsubmit</span>=<span class="string"><span class="delimiter">&quot;</span>event.preventDefault(); loginUser(<span class="local-variable">this</span>);<span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>    <i class="conum" data-value="2"></i><b>(2)</b>
    Login: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    Password: <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;button</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Login<span class="tag">&lt;/button&gt;</span>
  <span class="tag">&lt;/form&gt;</span>

  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://unpkg.com/@zetapush/client</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
  <span class="tag">&lt;script</span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">./index.js</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="tag">&lt;/script&gt;</span>
<span class="tag">&lt;/body&gt;</span>

<span class="tag">&lt;/html&gt;</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Form to create a new user</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Form to login a user</td>
</tr>
</table>
</div>
<div class="paragraph tab-container-end">
<p>-</p>
</div>
<div class="paragraph">
<p>Run the following command to run your application in local and serve the front part :</p>
</div>
<div class="listingblock">
<div class="title">Run the application</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">$ npm run start -- --serve-front</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test the workflow, just enter a login, a password and an email in the "Signup" part.
Then if you use <a href="https://mailtrap.io/" target="_blank" rel="noopener">mailtrap</a> for email sending, you can go
into the inbox provided by mailtrap and check that email has been received.
You can click on the link provided in the email. The account is then confirmed and
you are automatically redirected to something like <code><a href="http://localhost:2999#login" class="bare">http://localhost:2999#login</a></code>.
Now you can login using the same login and password pair (open your web browser console
to see connection messages).</p>
</div>
<div class="paragraph">
<p>You can also check that if you try to connect with wrong login or password, it doesn&#8217;t work
as expected. You can also create a new user but do not click on the link in the email.
You can check that you are not allowed to login.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Automatic configuration according to execution context</div>
<div class="paragraph">
<p>You can notice that you didn&#8217;t configure any URL for confirmation link and for
redirection to <code><a href="http://localhost:2999/#login" class="bare">http://localhost:2999/#login</a></code> once the account is confirmed.
Actually, ZetaPush automatically provides base URL of your front and your worker.
So you don&#8217;t bother to configure the base URLs. This is particularly useful
when your application is published on the ZetaPush cloud because you don&#8217;t
need to change configuration at all.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Automatic adaptation of the implementations</div>
<div class="paragraph">
<p>In the example, we use a SMTP server to send the confirmation email.
But you may want to use something else like <a href="https://fr.mailjet.com/" target="_blank" rel="noopener">Mailjet</a>.
ZetaPush provides an auto-adaptation system based on configuration.</p>
</div>
<div class="paragraph">
<p>In concrete terms, if you don&#8217;t configure <code>smtp</code> part in <code>application.json</code>
but instead you configure <code>mailjet</code> part, <code>StandardUserWorkflow</code> will
<a href="./reference.html#auto_implementation_selection">automatically switch implementation</a> used for sending email and will
use Mailjet instead of SMTP.</p>
</div>
<div class="paragraph">
<p>In future versions, other providers will be directly integrated.
The advantage is to configure the minimum as for Mailjet which
you only need to provide your Mailjet credentials.</p>
</div>
<div class="paragraph">
<p>Moreover, you could also choose to change the workflow by replacing
email by a <a href="./reference.html#extension-of-standard-user-workflow">SMS or anything else</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Extend and adapt the default workflow</div>
<div class="paragraph">
<p>The default behavior is totally adaptable. You can replace default implementations
provided by ZetaPush by your own implementations (for exemple, change token generation
algorithm, replace email by something else, replace templating system, &#8230;&#8203;).</p>
</div>
<div class="paragraph">
<p>You can learn <a href="./reference.html#extension-of-standard-user-workflow">how to extend this cloud service</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">User management samples</div>
<div class="paragraph">
<p>For a more real-world sample with a complete UI (signup form and login form) you can
go to <a href="https://github.com/zetapush/zetapush-examples/tree/master/standard-user-workflow" target="_blank" rel="noopener">GitHub ZetaPush Examples</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_store_data_in_your_application"><a class="anchor" href="#_store_data_in_your_application"></a>Store data in your application</h2>
<div class="sectionbody">
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>ZetaPush provides several technical services to manipulate data.
These services have the same complexity as the databases that are used
underneath. For example, you can use Elastic Search to index and search
but you have to understand how Elastic Search works. This can be time consuming.</p>
</div>
<div class="paragraph">
<p>ZetaPush wants to provide you the best developer experience in order to
focus on the functional and not technical issues. We want to offer
a way to quickly store, retrieve, search data. We aim to cover about 80%
of usages with our system. For example, you could write something like this in your
code:</p>
</div>
<div class="listingblock">
<div class="title">Data object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="error">@</span>Storable()
<span class="error">@</span>Searchable({<span class="key">name</span>: [<span class="string"><span class="delimiter">'</span><span class="content">firstname</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lastname</span><span class="delimiter">'</span></span>]})
<span class="reserved">class</span> User {
  <span class="reserved">private</span> firstname: string;
  <span class="reserved">private</span> lastname: string;
  <span class="reserved">private</span> birthdate: Date;
  <span class="error">@</span>Searchable()
  <span class="error">@</span>Unique()
  <span class="reserved">private</span> email: EmailAddress;
  <span class="error">@</span>Searchable()
  <span class="error">@</span>Unique()
  <span class="reserved">private</span> phoneNumber: PhoneNumber;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you could save data using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">userRepository.save(user);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also retrieve users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// get all users that exactly match the lastname</span>
userRepository.findAll({<span class="key">lastname</span>: <span class="string"><span class="delimiter">'</span><span class="content">Doe</span><span class="delimiter">'</span></span>});</code></pre>
</div>
</div>
<div class="paragraph">
<p>You could also search users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="comment">// search for users that combination of firstname and lastname</span>
<span class="comment">// matches the search terms</span>
userRepository.search(<span class="string"><span class="delimiter">'</span><span class="content">name</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">Jo Do</span><span class="delimiter">'</span></span>);
<span class="comment">// search for users which email that partially matches the search terms</span>
userRepository.search(<span class="string"><span class="delimiter">'</span><span class="content">email</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">@yopmail</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This feature is under construction and the API is not
fixed for the moment</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secure_your_application"><a class="anchor" href="#_secure_your_application"></a>Secure your application</h2>
<div class="sectionbody">
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>ZetaPush wants to provide you the best developer experience in order to
focus on the functional and not technical issues. We want to offer
a way to quickly secure your application. We aim to cover about 80%
of usages with our system. For example, you could write something like this in your
code:</p>
</div>
<div class="listingblock">
<div class="title">Cloud service</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="error">@</span>Injectable()
<span class="reserved">export</span> <span class="keyword">default</span> <span class="reserved">class</span> MyCustomCloudService {
  <span class="error">@</span>CanChangePassword
  changePassword(user) {
    <span class="comment">// code for changing a password of a user</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of using technical annotations or calls, we want
to provide you the possibility to define your own security
annotations. It makes the code easier to read and to maintain.</p>
</div>
<div class="paragraph">
<p>Here is an example of the code a custom annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> { isAdmin, isCurrentUser, SecurityException } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/security</span><span class="delimiter">'</span></span>;

<span class="reserved">export</span> const CanChangePassword = (user) =&gt; {
  <span class="comment">// an admin can change password of anyone</span>
  <span class="keyword">if</span>(isAdmin()) {
    <span class="keyword">return</span>;
  }
  <span class="comment">// a user can change only its own password</span>
  <span class="keyword">if</span>(isCurrentUser(user)) {
    <span class="keyword">return</span>;
  }
  <span class="comment">// not allowed</span>
  <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="error">`</span>You are not allowed to change password of <span class="predefined">$</span>{user.login}<span class="error">`</span>, user);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to control who can execute actions, we want
to provide a simple way to retrieve filtered data that comes from
database. For example, an admin could view everything while
a user could only see his friends.</p>
</div>
<div class="listingblock">
<div class="title">Data object</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="error">@</span>CanSeeAccount()
<span class="error">@</span>Storable()
<span class="error">@</span>Searchable({<span class="key">name</span>: [<span class="string"><span class="delimiter">'</span><span class="content">firstname</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">lastname</span><span class="delimiter">'</span></span>]})
<span class="reserved">class</span> User {
  <span class="reserved">private</span> firstname: string;
  <span class="reserved">private</span> lastname: string;
  <span class="reserved">private</span> birthdate: Date;
  <span class="error">@</span>Searchable()
  <span class="reserved">private</span> email: EmailAddress;
  <span class="error">@</span>Searchable()
  <span class="error">@</span>Sensitive()
  <span class="reserved">private</span> phoneNumber: PhoneNumber;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of the code a custom annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> { isAdmin, isCurrentUser, currentUser } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/security</span><span class="delimiter">'</span></span>;

const areFriends = (userFromDatabase, otherUser) =&gt; {
  <span class="comment">// ... (your code to check if the users are friends)</span>
}

<span class="reserved">export</span> const CanSeeAccount = (userFromDatabase) =&gt; {
  <span class="comment">// an admin can see all accounts</span>
  <span class="keyword">if</span>(isAdmin()) {
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="comment">// a user can see its account</span>
  <span class="keyword">if</span>(isCurrentUser(userFromDatabase)) {
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="comment">// a user can see accounts of his friends</span>
  <span class="keyword">if</span>(areFriends(currentUser(), userFromDatabase)) {
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="comment">// not allowed to see</span>
  <span class="keyword">return</span> <span class="predefined-constant">false</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, you could filter fields for example to prevent some sensitive
information to be visible to other users. Here we want to make phone
number only visible for an admin and the user that owns the phone number
(look at <code>@Sensitive()</code> annotation that indicates that the data
must not be visible unless we explicitly want it):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> { isAdmin, isCurrentUser, currentUser, accessSensitiveField } from <span class="string"><span class="delimiter">'</span><span class="content">@zetapush/security</span><span class="delimiter">'</span></span>;

const areFriends = (userFromDatabase, otherUser) =&gt; {
  <span class="comment">// ... (your code to check if the users are friends)</span>
}

<span class="reserved">export</span> const CanSeeAccount = (userFromDatabase) =&gt; {
  <span class="comment">// an admin can see all accounts</span>
  <span class="keyword">if</span>(isAdmin()) {
    <span class="keyword">return</span> accessSensitiveField(<span class="string"><span class="delimiter">'</span><span class="content">phoneNumber</span><span class="delimiter">'</span></span>);
  }
  <span class="comment">// a user can see its account</span>
  <span class="keyword">if</span>(isCurrentUser(userFromDatabase)) {
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="comment">// a user can see accounts of his friends</span>
  <span class="keyword">if</span>(areFriends(currentUser(), userFromDatabase)) {
    <span class="keyword">return</span> <span class="predefined-constant">true</span>;
  }
  <span class="comment">// not allowed to see</span>
  <span class="keyword">return</span> <span class="predefined-constant">false</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These features are under construction and the API is not
fixed for the moment</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-12-18 11:12:17 UTC
</div>
</div>
</body>
</html>